<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Football Mobile League</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #00c6ff;
            --gold-accent: #ffd700;
            --stadium-green: #28a745;
            --danger-red: #dc3545;
            --grey: #6c757d;

            /* --- Theme Variables --- */
            --bg-main: #121212;
            --bg-light: #1e1e1e;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #444;
        }

        body[data-theme="light"] {
            --bg-main: #f0f2f5;
            --bg-light: #ffffff;
            --bg-lighter: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* --- Navbar --- */
        .navbar {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color) !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand img, .navbar-brand svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            font-weight: 500;
            padding: 10px 15px;
            transition: color 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: var(--primary-color);
        }
        
        #theme-toggle {
            font-size: 1.1rem;
            line-height: 1;
        }

        /* --- Live Ticker --- */
        .live-ticker {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px;
            font-weight: 500;
            animation: tickerSlide 20s linear infinite;
            white-space: nowrap;
            overflow: hidden;
        }

        @keyframes tickerSlide {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* --- Hero Section --- */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)), url('stadium.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 100px 20px 80px 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 650px;
            margin: 20px auto 30px auto;
            font-weight: 300;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 12px 30px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
        }
        .btn-secondary {
            background-color: var(--grey);
            border-color: var(--grey);
        }

        /* --- Section Styling --- */
        section {
            padding: 60px 0;
            transition: background-color 0.3s ease;
        }
        section:nth-of-type(odd) {
            background-color: var(--bg-light);
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 40px;
            text-align: center;
            text-transform: uppercase;
        }
        
        /* --- Card Styling --- */
        .card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .card-body {
            padding: 1.5rem;
        }
        .card-header {
            background-color: var(--bg-lighter);
            border-bottom: 1px solid var(--border-color);
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* --- Standings Table --- */
        .league-table {
            background-color: var(--bg-light);
            border-color: var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .league-table thead th {
            background-color: var(--bg-lighter);
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease;
        }
        
        .league-table tbody tr:hover {
            background-color: var(--bg-lighter);
        }
        
        .league-table th, .league-table td {
            vertical-align: middle;
            padding: 0.9rem 0.75rem;
            border-bottom-color: var(--border-color);
        }
        
        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .player-name-cell img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        
        .player-profile-link {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.3s;
        }
        .player-profile-link:hover {
            color: var(--primary-color);
        }

        .pos-cell { font-weight: 700; font-size: 1.1rem; width: 40px; text-align: center; }
        .pts-cell { font-weight: 700; font-size: 1.1rem; }

        .form-cell .form-bubble {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
            margin: 0 1px;
        }
        .form-bubble-W { background-color: var(--stadium-green); }
        .form-bubble-D { background-color: var(--grey); }
        .form-bubble-L { background-color: var(--danger-red); }

        .top-team-row { border-left: 4px solid var(--gold-accent); }
        .mid-team-row { border-left: 4px solid var(--primary-color); }
        .bottom-team-row { border-left: 4px solid var(--danger-red); }

        /* --- Fixtures / Results Card --- */
        .matchday-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .matchday-nav h4 { color: var(--text-primary); font-weight: 500; margin: 0; width: 150px; text-align: center; }
        
        .match-card, .result-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .match-card:hover, .result-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .match-player, .result-player {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 40%;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .match-player img, .result-player img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-main);
        }
        .match-player:last-of-type, .result-player:last-of-type {
            justify-content: flex-end;
            text-align: right;
        }
        
        .match-info, .result-info { text-align: center; width: 20%; }
        .match-info .vs { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .match-info .date { font-size: 0.85rem; color: var(--text-secondary); }
        
        .result-info .score { font-size: 2rem; font-weight: 900; color: var(--text-primary); letter-spacing: 2px; }
        .result-info .score .winner { color: var(--gold-accent); }

        .admin-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .match-card, .result-card { position: relative; }

        /* --- Players Section --- */
        .player-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.15);
        }
        .player-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem auto;
            border: 3px solid var(--primary-color);
            background-color: var(--bg-main);
        }
        .player-card .card-title { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }
        .player-card .card-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; }

        /* --- Prizes Section --- */
        .prize-card {
            background: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .prize-card:hover { transform: scale(1.03); }
        .prize-card .prize-icon { font-size: 3rem; margin-bottom: 1rem; }
        .prize-card-1 .prize-icon { color: var(--gold-accent); }
        .prize-card-2 .prize-icon { color: #c0c0c0; }
        .prize-card-3 .prize-icon { color: #cd7f32; }
        .prize-card h3 { font-size: 1.3rem; font-weight: 500; color: var(--text-secondary); }
        .prize-card p { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .prize-total { text-align: center; font-size: 1.5rem; margin-bottom: 2rem; }
        .prize-total strong { color: var(--primary-color); font-size: 2rem; font-weight: 700; }
        
        /* --- Admin / Modals --- */
        .admin-mode { display: none; }
        
        .modal-content {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-header, .modal-footer {
            border-bottom-color: var(--border-color);
            border-top-color: var(--border-color);
            transition: border-color 0.3s ease;
        }
        .btn-close {
            filter: var(--text-primary) == '#ffffff' ? invert(1) : none;
        }
        .form-control, .form-select {
            background-color: var(--bg-main);
            border-color: var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-main);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-control:disabled { background-color: var(--bg-lighter); }
        
        .result-modal-scores { display: flex; justify-content: center; align-items: center; gap: 1rem; }
        .result-modal-scores label { font-size: 1.1rem; font-weight: 500; }
        .result-modal-scores input { width: 80px; font-size: 2rem; font-weight: 700; text-align: center; }
        .result-modal-vs { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        
        /* Toast Styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1rem; }
            .navbar-brand { font-size: 1.2rem; }
            .nav-link { font-size: 0.9rem; padding: 8px 12px; }
            
            .match-card, .result-card { flex-direction: column; gap: 1rem; padding: 1rem; }
            .match-player, .result-player { width: 100%; font-size: 1rem; }
            .match-player:last-of-type, .result-player:last-of-type { justify-content: flex-start; text-align: left; }
            .match-info, .result-info { width: 100%; display: flex; justify-content: space-between; align-items: center; }
            .result-info .score { font-size: 1.8rem; }
            .match-info .vs { order: 2; }
            .match-info .date { order: 1; }
            
            .table-responsive { border-radius: 10px; }
            .table { font-size: 0.85rem; }
            .player-name-cell img { width: 30px; height: 30px; }
            
            /* Hide columns on mobile to save space */
            .table th:nth-child(7), .table td:nth-child(7), /* GF */
            .table th:nth-child(8), .table td:nth-child(8), /* GA */
            .table th:nth-child(10), .table td:nth-child(10) /* Form */
            {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="#007bff">
                    <path d="M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM76.4,26.66l-6.85,6.85a28,28,0,0,1-13.7,11.37L50,50,44.15,44.88a28,28,0,0,1-11.37-13.7L25.93,23.6A38.56,38.56,0,0,1,50,11.5a38.16,38.16,0,0,1,26.4,15.16ZM23.6,74.07l6.85-6.85a28,28,0,0,1,13.7-11.37L50,50,55.85,55.12a28,28,0,0,1,11.37,13.7l6.85,6.85A38.56,38.56,0,0,1,50,88.5,38.16,38.16,0,0,1,23.6,74.07Z"/>
                </svg>
                E-FOOTBALL LEAGUE
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#standings">Standings</a></li>
                    <li class="nav-item"><a class="nav-link" href="#fixtures">Fixtures</a></li>
                    <li class="nav-item"><a class="nav-link" href="#results">Results</a></li>
                    <li class="nav-item"><a class="nav-link" href="#players">Players</a></li>
                    <li class="nav-item"><a class="nav-link" href="#prizes">Prizes</a></li>
                    <li class="nav-item">
                        <button class="btn nav-link" id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                            <i class="fa-solid fa-sun"></i> </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary ms-2" onclick="showAdminLogin()">
                            <i class="fa-solid fa-lock me-1"></i> Admin
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="live-ticker" id="liveTicker">
        Welcome to the eFootball Mobile League! Check here for live score updates...
    </div>

    <section class="hero">
        <div class="container">
            <h1>HALOTEL LEAGUE</h1>
            <p>Join the exciting Halotel league! Win data prizes from a pool of 12 GB. Check the standings, fixtures, and results here.</p>
            <a href="#standings" class="btn btn-primary">View Standings</a>
        </div>
    </section>

    <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter Password" aria-label="Admin Password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="loginAdmin()">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlayerModalLabel">Add Player</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">Player Name</label>
                        <input type="text" id="playerName" class="form-control" placeholder="Enter name" aria-label="Player Name">
                    </div>
                    <div class="mb-3">
                        <label for="playerAvatarFile" class="form-label">Upload Avatar (Recommended)</label>
                        <input type="file" id="playerAvatarFile" class="form-control" accept="image/png, image/jpeg, image/webp">
                    </div>
                    <div class="text-center text-secondary my-2">OR</div>
                    <div class="mb-3">
                        <label for="playerAvatarUrl" class="form-label">Avatar URL</label>
                        <input type="url" id="playerAvatarUrl" class="form-control" placeholder="Paste image URL" aria-label="Player Avatar URL">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitPlayer()">Add Player</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addFixtureModal" tabindex="-1" aria-labelledby="addFixtureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFixtureModalLabel">Add Fixture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fixturePlayer1" class="form-label">Player 1</label>
                        <select id="fixturePlayer1" class="form-select" aria-label="Player 1"></select>
                    </div>
                    <div class="mb-3">
                        <label for="fixturePlayer2" class="form-label">Player 2</label>
                        <select id="fixturePlayer2" class="form-select" aria-label="Player 2"></select>
                    </div>
                    <div class="mb-3">
                        <label for="fixtureDate" class="form-label">Date</label>
                        <input type="date" id="fixtureDate" class="form-control" aria-label="Fixture Date">
                    </div>
                    <div class="mb-3">
                        <label for="fixtureMatchday" class="form-label">Matchday</label>
                        <input type="number" id="fixtureMatchday" class="form-control" min="1" value="1" aria-label="Matchday">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitFixture()">Add Fixture</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Enter Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resultFixtureId">
                    <div class="text-center mb-3">
                        <h6 id="resultModalPlayer1Name">Player 1</h6>
                    </div>
                    <div class="result-modal-scores">
                        <input type="number" id="resultScore1" class="form-control" min="0" aria-label="Player 1 Score">
                        <span class="result-modal-vs">-</span>
                        <input type="number" id="resultScore2" class="form-control" min="0" aria-label="Player 2 Score">
                    </div>
                     <div class="text-center mt-3">
                        <h6 id="resultModalPlayer2Name">Player 2</h6>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitResult()">Update Result</button>
                </div>
            </div>
        </div>
    </div>

    <section id="standings" class="py-5">
        <div class="container">
            <h2 class="section-title">Standings</h2>
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table league-table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" class="pos-cell">#</th>
                                    <th scope="col" style="width: 30%;">Player</th>
                                    <th scope="col">MP</th>
                                    <th scope="col">W</th>
                                    <th scope="col">D</th>
                                    <th scope="col">L</th>
                                    <th scope="col">GF</th>
                                    <th scope="col">GA</th>
                                    <th scope="col">GD</th>
                                    <th scope="col" class="form-cell">Form</th>
                                    <th scope="col" class="pts-cell">Pts</th>
                                </tr>
                            </thead>
                            <tbody id="standingsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="admin-mode mt-4 text-center">
                <button class="btn btn-primary me-2" onclick="showAddPlayerModal()">
                    <i class="fa-solid fa-user-plus me-1"></i> Add Player
                </button>
                <button class="btn btn-danger" onclick="resetLeague()">
                    <i class="fa-solid fa-trash me-1"></i> Reset League
                </button>
            </div>
        </div>
    </section>

    <section id="fixtures" class="py-5">
        <div class="container">
            <h2 class="section-title">Fixtures</h2>
            <div class="matchday-nav">
                <button class="btn btn-primary" id="prevMatchday" onclick="changeMatchday(-1)">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h4 id="currentMatchday">Matchday 1</h4>
                <button class="btn btn-primary" id="nextMatchday" onclick="changeMatchday(1)">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            <div id="fixturesContainer">
                </div>
            <div class="admin-mode mt-4 text-center">
                <button class="btn btn-primary me-2" onclick="showAddFixtureModal()">
                    <i class="fa-solid fa-calendar-plus me-1"></i> Add Fixture
                </button>
                <button class="btn btn-success" onclick="generateFixtures()">
                    <i class="fa-solid fa-cogs me-1"></i> Generate Fixtures
                </button>
            </div>
        </div>
    </section>

    <section id="results" class="py-5">
        <div class="container">
            <h2 class="section-title">Results</h2>
            <div class="row justify-content-center mb-4">
                <div class="col-md-6">
                    <label for="teamSelector" class="form-label">Filter by Player</LabeL>
                    <select id="teamSelector" class="form-select" onchange="filterTeamResults()" aria-label="Select Player">
                        <option value="">Show All</option>
                    </select>
                </div>
            </div>
            <div id="resultsContainer">
                </div>
        </div>
    </section>

    <section id="players" class="py-5">
        <div class="container">
            <h2 class="section-title">Players</h2>
            <div class="row" id="playersContainer">
                </div>
        </div>
    </section>

    <section id="prizes" class="py-5">
        <div class="container">
            <h2 class="section-title">League Prizes</h2>
            <p class="prize-total">Total prize pool: <strong>12 GB</strong> of Halotel data!</p>
            <div class="row g-4">
                <div class="col-md-4"><div class="prize-card prize-card-1"><div class="prize-icon"><i class="fa-solid fa-trophy"></i></div><h3>1st Place</h3><p>1.7 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card prize-card-2"><div class="prize-icon"><i class="fa-solid fa-medal"></i></div><h3>2nd Place</h3><p>1.5 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card prize-card-3"><div class="prize-icon"><i class="fa-solid fa-award"></i></div><h3>3rd Place</h3><p>1.3 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>4th Place</h3><p>1.0 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>5th Place</h3><p>900 MB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>6th Place</h3><p>600 MB</p></div></div>
            </div>
            <p class="text-center text-secondary mt-4">
                <em>Data prizes will be applied to your Halotel number. Validity may vary.</em>
            </p>
        </div>
    </section>

    <section id="import-export" class="py-5">
        <div class="container">
            <h2 class="section-title">Import/Export Data (Admin)</h2>
            <div class="card">
                <div class="card-body">
                    <textarea id="dataJson" class="form-control" rows="5" placeholder="Paste JSON here to import" aria-label="JSON Data"></textarea>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary me-2" onclick="importData()">Import Data</button>
                        <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
 
    <script>
        // ================================================================
        //
        
        // ================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCLycBxpQ3MMIDLYjmBqMZv32FIu2eDXF4", // <--- REPLACE
            authDomain: "efootball-app-ce90b.firebaseapp.com"", // <--- REPLACE
            projectId: "efootball-app-ce90b", // <--- REPLACE
            storageBucket: "efootball-app-ce90b.firebasestorage.app", // <--- REPLACE
            messagingSenderId: "387933114333", // <--- REPLACE
            appId: "1:387933114333:web:1c85dbadacf70d0406b034" // <--- REPLACE
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const password = "Genie"; // Your admin password
        let leagueData = { players: [], fixtures: [], results: [] };
        let currentMatchday = 1;
        let totalMatchdays = 1;
        let isAdmin = false;
        
        // NEW: Default SVG avatar (replaces placeholder.com)
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%236c757d'%3E%3Cpath d='M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM50,15A35,35,0,1,1,15,50,35,35,0,0,1,50,15ZM50,25A10,10,0,1,1,40,35,10,10,0,0,1,50,25ZM50,80a27,27,0,0,1-25-12.87c.2-8.3,16.72-12.93,25-12.93s24.8,4.63,25,12.93A27,27,0,0,1,50,80Z'/%3E%3C/svg%3E";

        // --- NEW: Theme Toggle Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.dataset.theme = 'light';
                themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('theme', 'light');
            } else {
                delete document.body.dataset.theme;
                themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // Apply saved theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            loadData(); // Load Firebase data after theme is set
        });
        // --- End Theme Logic ---

        // Load data from Firebase
        async function loadData() {
            try {
                const leagueSnapshot = await db.collection('league').doc('data').get();
                if (leagueSnapshot.exists) {
                    leagueData = leagueSnapshot.data();
                    if (!leagueData.players) leagueData.players = [];
                    if (!leagueData.fixtures) leagueData.fixtures = [];
                    if (!leagueData.results) leagueData.results = [];
                } else {
                    await saveData(false); // Don't show toast on first-time save
                }
                updateViews();
                populateTeamSelector();
                populateFixtureSelectors();
                calculateTotalMatchdays();
                updateLiveTicker();
            } catch (error) {
                console.error("Error loading data: ", error);
                showToast('Error loading data! Check Firebase config.', 'danger');
            }
        }

        // Save data to Firebase
        async function saveData(showSuccessToast = true) {
            try {
                await db.collection('league').doc('data').set(leagueData);
                updateViews();
                if(isAdmin && showSuccessToast) {
                    showToast('Data saved successfully!', 'success');
                }
            } catch (error) {
                console.error("Error saving data: ", error);
                showToast('Error saving data! Check Firebase rules.', 'danger');
            }
        }

        // Update all views
        function updateViews() {
            updateStandings();
            updateFixtures();
            updateResults();
            updatePlayers();
        }

        // Calculate total matchdays
        function calculateTotalMatchdays() {
            totalMatchdays = Math.max(...leagueData.fixtures.map(f => f.matchday || 1), 1);
            document.getElementById('currentMatchday').innerText = `Matchday ${currentMatchday}`;
        }

        // Update Live Ticker
        function updateLiveTicker() {
            const ticker = document.getElementById('liveTicker');
            const recentResults = leagueData.results.slice(-5).map(r => {
                const fixture = leagueData.fixtures.find(f => f.id === r.fixtureId);
                if (fixture) {
                    const p1 = leagueData.players.find(p => p.id === fixture.player1)?.name || '...';
                    const p2 = leagueData.players.find(p => p.id === fixture.player2)?.name || '...';
                    return `RESULT: ${p1} ${r.score1} - ${r.score2} ${p2}`;
                }
                return '';
            }).filter(r => r).join(' | ');
            ticker.innerText = recentResults || 'Welcome to the eFootball Mobile League! Check here for live score updates...';
        }

        // Show Toast Notification
        function showToast(message, type = 'success') {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            const bgClass = type === 'danger' ? 'bg-danger' : (type === 'success' ? 'bg-success' : 'bg-primary');
            toastContainer.innerHTML = `
                <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toastContainer);
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'), { delay: 3000 });
            toast.show();
            setTimeout(() => toastContainer.remove(), 3500);
        }

        // Calculate Player Form
        function calculatePlayerForm(playerId) {
            const playerFixtures = leagueData.fixtures
                .filter(f => f.player1 === playerId || f.player2 === playerId)
                .map(f => f.id);
            
            const playerResults = leagueData.results
                .filter(r => playerFixtures.includes(r.fixtureId))
                .sort((a, b) => b.fixtureId - a.fixtureId)
                .slice(0, 5);

            return playerResults.map(result => {
                const fixture = leagueData.fixtures.find(f => f.id === result.fixtureId);
                if (fixture.player1 === playerId) {
                    return result.score1 > result.score2 ? 'W' : (result.score1 < result.score2 ? 'L' : 'D');
                } else {
                    return result.score2 > result.score1 ? 'W' : (result.score2 < result.score1 ? 'L' : 'D');
                }
            }).reverse();
        }

        // Update Standings Table
        function updateStandings() {
            const table = document.getElementById('standingsTable');
            table.innerHTML = '';
            const sortedPlayers = leagueData.players.slice().sort((a, b) => {
                if (b.points - a.points !== 0) return b.points - a.points;
                if (b.gd - a.gd !== 0) return b.gd - a.gd;
                return b.gf - a.gf;
            });
            sortedPlayers.forEach((player, index) => {
                let rowClass = index < 3 ? 'top-team-row' : index >= sortedPlayers.length - 3 ? 'bottom-team-row' : 'mid-team-row';
                
                const playerForm = calculatePlayerForm(player.id);
                const formHtml = playerForm.map(f => {
                    const bubbleClass = f === 'W' ? 'form-bubble-W' : (f === 'D' ? 'form-bubble-D' : 'form-bubble-L');
                    return `<span class="form-bubble ${bubbleClass}">${f}</span>`;
                }).join('');

                const row = `
                    <tr class="${rowClass}">
                        <td class="pos-cell">${index + 1} ${index === 0 ? '<i class="fa-solid fa-trophy text-warning"></i>' : ''}</td>
                        <td class="player-name-cell">
                            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
                            <a href="#" class="player-profile-link" onclick="event.preventDefault(); showPlayerProfile(${player.id})">${player.name}</a>
                        </td>
                        <td>${player.mp}</td>
                        <td>${player.w}</td>
                        <td>${player.d}</td>
                        <td>${player.l}</td>
                        <td>${player.gf}</td>
                        <td>${player.ga}</td>
                        <td>${player.gd}</td>
                        <td class="form-cell">${formHtml}</td>
                        <td class="pts-cell">${player.points}</td>
                    </tr>
                `;
                table.insertAdjacentHTML('beforeend', row);
            });
            toggleAdminControls();
        }

        // Update Fixtures
        function updateFixtures() {
            const container = document.getElementById('fixturesContainer');
            container.innerHTML = '';
            const matchdayFixtures = leagueData.fixtures.filter(f => f.matchday === currentMatchday);
            
            if (matchdayFixtures.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">No fixtures for this matchday.</p>';
                return;
            }
            
            let fixturesFound = false;
            matchdayFixtures.forEach(fixture => {
                const p1 = leagueData.players.find(p => p.id === fixture.player1) || { name: 'Unknown', avatar: defaultAvatar };
                const p2 = leagueData.players.find(p => p.id === fixture.player2) || { name: 'Unknown', avatar: defaultAvatar };
                const result = leagueData.results.find(r => r.fixtureId === fixture.id);
                
                if(result) return; // Skip if result exists
                
                fixturesFound = true;
                const card = `
                    <div class="match-card">
                        <div class="admin-mode admin-controls">
                            <button class="btn btn-sm btn-primary" onclick="enterResult(${fixture.id})" aria-label="Enter Result">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFixture(${fixture.id})" aria-label="Delete Fixture">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        <div class="match-player">
                            <img src="${p1.avatar || defaultAvatar}" alt="${p1.name}">
                            <span>${p1.name}</span>
                        </div>
                        <div class="match-info">
                            <div class="vs">VS</div>
                            <div class="date">${fixture.date}</div>
                        </div>
                        <div class="match-player">
                            <span>${p2.name}</span>
                            <img src="${p2.avatar || defaultAvatar}" alt="${p2.name}">
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });
            
            if(!fixturesFound) {
                 container.innerHTML = '<p class="text-center text-secondary">All matches for this matchday are complete.</p>';
            }
            toggleAdminControls();
        }

        // Update Results
        function updateResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            const selectedTeam = parseInt(document.getElementById('teamSelector').value) || null;
            
            let filteredResults = leagueData.results;
            if (selectedTeam) {
                filteredResults = filteredResults.filter(r => {
                    const fixture = leagueData.fixtures.find(f => f.id === r.fixtureId);
                    return fixture && (fixture.player1 === selectedTeam || fixture.player2 === selectedTeam);
                });
            }
            
            if (filteredResults.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">No results recorded yet.</p>';
                return;
            }

            filteredResults.sort((a,b) => b.fixtureId - a.fixtureId).forEach(result => {
                const fixture = leagueData.fixtures.find(f => f.id === result.fixtureId);
                if (fixture) {
                    const p1 = leagueData.players.find(p => p.id === fixture.player1) || { name: 'Unknown', avatar: defaultAvatar };
                    const p2 = leagueData.players.find(p => p.id === fixture.player2) || { name: 'Unknown', avatar: defaultAvatar };
                    
                    const score1Class = result.score1 > result.score2 ? 'winner' : '';
                    const score2Class = result.score2 > result.score1 ? 'winner' : '';

                    const card = `
                        <div class="result-card">
                            <div class="admin-mode admin-controls">
                                <button class="btn btn-sm btn-warning" onclick="enterResult(${fixture.id})" aria-label="Edit Result">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteResult(${result.fixtureId})" aria-label="Delete Result">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <div class="result-player">
                                <img src="${p1.avatar || defaultAvatar}" alt="${p1.name}">
                                <span>${p1.name}</span>
                            </div>
                            <div class="result-info">
                                <div class="score">
                                    <span class="${score1Class}">${result.score1}</span> - <span class="${score2Class}">${result.score2}</span>
                                </div>
                                <div class="date">${fixture.date} (MD ${fixture.matchday})</div>
                            </div>
                            <div class="result-player">
                                <span>${p2.name}</span>
                                <img src="${p2.avatar || defaultAvatar}" alt="${p2.name}">
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', card);
                }
            });
            toggleAdminControls();
        }

        // Update Players Section
        function updatePlayers() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';
            leagueData.players.forEach(player => {
                const card = `
                    <div class="col-md-4 col-sm-6 mb-4">
                        <div class="player-card">
                            <img src="${player.avatar || defaultAvatar}" alt="${player.name}">
                            <div class="card-body p-0">
                                <h5 class="card-title">${player.name}</h5>
                                <p class="card-text">
                                    Points: ${player.points} | Played: ${player.mp}<br>
                                    W: ${player.w} | D: ${player.d} | L: ${player.l}<br>
                                    Goals: ${player.gf}:${player.ga} (GD: ${player.gd})
                                </p>
                                <button class="btn btn-sm btn-outline-primary" onclick="showPlayerProfile(${player.id})">
                                    View Profile
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        // Populate Selectors
        function populateTeamSelector() {
            const selector = document.getElementById('teamSelector');
            selector.innerHTML = '<option value="">Show All</option>';
            leagueData.players.sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                selector.insertAdjacentHTML('beforeend', `<option value="${player.id}">${player.name}</option>`);
            });
        }

        function populateFixtureSelectors() {
            const p1 = document.getElementById('fixturePlayer1');
            const p2 = document.getElementById('fixturePlayer2');
            p1.innerHTML = p2.innerHTML = '<option value="">Select Player</option>';
            leagueData.players.sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                const opt = `<option value="${player.id}">${player.name}</option>`;
                p1.insertAdjacentHTML('beforeend', opt);
                p2.insertAdjacentHTML('beforeend', opt);
            });
        }

        function filterTeamResults() { updateResults(); }

        // --- Admin Logic ---
        function showAdminLogin() {
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }
        
        function toggleAdminControls() {
            const displayValue = isAdmin ? 'block' : 'none';
            document.querySelectorAll('.admin-mode').forEach(el => {
                el.style.display = displayValue;
            });
            // Fix for table cells
            document.querySelectorAll('#standingsTable .admin-mode').forEach(el => {
                 el.style.display = isAdmin ? 'table-cell' : 'none';
            });
            document.querySelectorAll('.admin-controls').forEach(el => {
                 el.style.display = isAdmin ? 'flex' : 'none';
            });
        }

        function loginAdmin() {
            if (document.getElementById('adminPassword').value === password) {
                isAdmin = true;
                toggleAdminControls();
                showToast('Admin mode enabled!', 'success');
            } else {
                showToast('Incorrect password!', 'danger');
            }
            document.getElementById('adminPassword').value = '';
            bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
        }

        function showAddPlayerModal() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            new bootstrap.Modal(document.getElementById('addPlayerModal')).show();
        }
        
        // --- NEW: Image Resizer ---
        // Converts a file to a Base64 WebP image
        function resizeAndConvertImage(file, maxSize = 128) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    return reject(new Error('File is not an image.'));
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to WebP for high efficiency
                        const dataUrl = canvas.toDataURL('image/webp', 0.85);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- UPDATED: submitPlayer (handles File Upload) ---
        async function submitPlayer() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                showToast('Player name is required!', 'danger'); return;
            }
            if (leagueData.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('A player with this name already exists!', 'danger'); return;
            }

            const file = document.getElementById('playerAvatarFile').files[0];
            const url = document.getElementById('playerAvatarUrl').value.trim();
            let avatarData = '';

            try {
                if (file) {
                    // Prioritize file upload
                    showToast('Processing image...', 'info');
                    avatarData = await resizeAndConvertImage(file, 128); // Resize to 128x128 max
                } else if (url) {
                    // Fallback to URL
                    avatarData = url;
                }

                const nextId = leagueData.players.length > 0 ? Math.max(...leagueData.players.map(p => p.id)) + 1 : 1;
                leagueData.players.push({
                    id: nextId, name, avatar: avatarData, 
                    points: 0, mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0
                });
                
                await saveData(); // Save and update views
                populateTeamSelector();
                populateFixtureSelectors();
                
                bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide();
                document.getElementById('playerName').value = '';
                document.getElementById('playerAvatarFile').value = '';
                document.getElementById('playerAvatarUrl').value = '';
                
            } catch (error) {
                console.error("Error processing image:", error);
                showToast('Could not process image. Try a different file or URL.', 'danger');
            }
        }

        function showAddFixtureModal() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            new bootstrap.Modal(document.getElementById('addFixtureModal')).show();
        }

        function submitFixture() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            const p1 = parseInt(document.getElementById('fixturePlayer1').value);
            const p2 = parseInt(document.getElementById('fixturePlayer2').value);
            const date = document.getElementById('fixtureDate').value;
            const md = parseInt(document.getElementById('fixtureMatchday').value) || 1;
            
            if (!p1 || !p2 || !date) {
                showToast('All fields are required!', 'danger'); return;
            }
            if (p1 === p2) {
                showToast('Player cannot play against themselves!', 'danger'); return;
            }
            
            const nextId = leagueData.fixtures.length > 0 ? Math.max(...leagueData.fixtures.map(f => f.id)) + 1 : 1;
            leagueData.fixtures.push({ id: nextId, player1: p1, player2: p2, date, matchday: md });
            
            calculateTotalMatchdays();
            saveData();
            bootstrap.Modal.getInstance(document.getElementById('addFixtureModal')).hide();
        }

        // --- UPDATED: enterResult (pre-fills modal) ---
        function enterResult(fixtureId) {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) { showToast('Fixture not found!', 'danger'); return; }
            
            const p1 = leagueData.players.find(p => p.id === fixture.player1) || { name: 'Player 1' };
            const p2 = leagueData.players.find(p => p.id === fixture.player2) || { name: 'Player 2' };

            document.getElementById('resultModalLabel').innerText = `Result: ${p1.name} vs ${p2.name}`;
            document.getElementById('resultFixtureId').value = fixtureId;
            document.getElementById('resultModalPlayer1Name').innerText = p1.name;
            document.getElementById('resultModalPlayer2Name').innerText = p2.name;
            
            const existingResult = leagueData.results.find(r => r.fixtureId === fixtureId);
            document.getElementById('resultScore1').value = existingResult ? existingResult.score1 : '';
            document.getElementById('resultScore2').value = existingResult ? existingResult.score2 : '';
            
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        // --- UPDATED: submitResult (handles editing) ---
        async function submitResult() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            const fixtureId = parseInt(document.getElementById('resultFixtureId').value);
            const score1 = parseInt(document.getElementById('resultScore1').value);
            const score2 = parseInt(document.getElementById('resultScore2').value);
            
            if (isNaN(fixtureId) || isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showToast('Valid scores are required!', 'danger'); return;
            }
            
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) { showToast('Fixture not found!', 'danger'); return; }

            // Reverse stats if result already exists
            const existingResultIndex = leagueData.results.findIndex(r => r.fixtureId === fixtureId);
            if (existingResultIndex !== -1) {
                const oldResult = leagueData.results[existingResultIndex];
                reverseStatsFromResult(fixtureId, oldResult);
                leagueData.results.splice(existingResultIndex, 1);
            }
            
            leagueData.results.push({ fixtureId, score1, score2 });
            
            const p1 = leagueData.players.find(p => p.id === fixture.player1);
            const p2 = leagueData.players.find(p => p.id === fixture.player2);
            
            if (p1 && p2) {
                p1.mp += 1; p2.mp += 1;
                p1.gf += score1; p1.ga += score2;
                p2.gf += score2; p2.ga += score1;
                p1.gd = p1.gf - p1.ga;
                p2.gd = p2.gf - p2.ga;
                
                if (score1 > score2) { p1.points += 3; p1.w += 1; p2.l += 1; }
                else if (score2 > score1) { p2.points += 3; p2.w += 1; p1.l += 1; }
                else { p1.points += 1; p2.points += 1; p1.d += 1; p2.d += 1; }
            }
            
            await saveData();
            updateLiveTicker();
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
        }

        // Helper to reverse stats
        function reverseStatsFromResult(fixtureId, result) {
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) return;

            const p1 = leagueData.players.find(p => p.id === fixture.player1);
            const p2 = leagueData.players.find(p => p.id === fixture.player2);
            
            if (p1 && p2) {
                p1.mp -= 1; p2.mp -= 1;
                p1.gf -= result.score1; p1.ga -= result.score2;
                p2.gf -= result.score2; p2.ga -= result.score1;
                p1.gd = p1.gf - p1.ga;
                p2.gd = p2.gf - p2.ga;
                
                if (result.score1 > result.score2) { p1.points -= 3; p1.w -= 1; p2.l -= 1; }
                else if (result.score2 > result.score1) { p2.points -= 3; p2.w -= 1; p1.l -= 1; }
                else { p1.points -= 1; p2.points -= 1; p1.d -= 1; p2.d -= 1; }
            }
        }

        // Delete Player
        async function deletePlayer(id) {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            if (confirm('Delete this player? This will remove all their fixtures and results.')) {
                const fixturesToRemove = leagueData.fixtures.filter(f => f.player1 === id || f.player2 === id);
                
                fixturesToRemove.forEach(fixture => {
                    const result = leagueData.results.find(r => r.fixtureId === fixture.id);
                    if(result) { reverseStatsFromResult(fixture.id, result); }
                });
                
                const fixtureIdsToRemove = fixturesToRemove.map(f => f.id);
                leagueData.fixtures = leagueData.fixtures.filter(f => !fixtureIdsToRemove.includes(f.id));
                leagueData.results = leagueData.results.filter(r => !fixtureIdsToRemove.includes(r.fixtureId));
                leagueData.players = leagueData.players.filter(p => p.id !== id);

                await saveData();
                populateTeamSelector();
                populateFixtureSelectors();
            }
        }

        // Delete Fixture
        async function deleteFixture(id) {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            if (confirm('Delete this fixture? If it has a result, stats will be reversed.')) {
                const result = leagueData.results.find(r => r.fixtureId === id);
                if(result) { reverseStatsFromResult(id, result); }
                
                leagueData.fixtures = leagueData.fixtures.filter(f => f.id !== id);
                leagueData.results = leagueData.results.filter(r => r.fixtureId !== id);
                
                calculateTotalMatchdays();
                await saveData();
            }
        }

        // Delete Result
        async function deleteResult(fixtureId) {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            if (confirm('Delete this result? Player stats will be reversed.')) {
                const resultIndex = leagueData.results.findIndex(r => r.fixtureId === fixtureId);
                if (resultIndex !== -1) {
                    const result = leagueData.results[resultIndex];
                    reverseStatsFromResult(fixtureId, result);
                    leagueData.results.splice(resultIndex, 1);
                    await saveData();
                    updateLiveTicker();
                }
            }
        }

        // Generate Fixtures
        async function generateFixtures() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            if (leagueData.players.length < 2) {
                showToast('You need at least 2 players to generate fixtures!', 'danger'); return;
            }
            if (leagueData.fixtures.length > 0 && !confirm('Clear all existing fixtures and results to generate new ones?')) {
                return;
            }
            
            leagueData.fixtures = [];
            leagueData.results = [];
            leagueData.players.forEach(p => {
                p.mp = 0; p.w = 0; p.d = 0; p.l = 0;
                p.gf = 0; p.ga = 0; p.gd = 0; p.points = 0;
            });

            const players = [...leagueData.players.map(p => p.id)];
            if (players.length % 2 === 1) players.push(null); // Add bye
            
            const numRounds = players.length - 1;
            const halfSize = players.length / 2;
            let fixtures = [];
            let id = 1;
            const startDate = new Date();

            for (let round = 0; round < numRounds; round++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (round * 7)); // 1 week per matchday
                const dateString = date.toISOString().split('T')[0];

                for (let i = 0; i < halfSize; i++) {
                    const p1 = players[i];
                    const p2 = players[players.length - 1 - i];
                    if (p1 && p2) { // Skip bye matches
                        fixtures.push({
                            id: id++,
                            player1: (round % 2 === 1 && i === 0) ? p2 : p1, // Swap home
                            player2: (round % 2 === 1 && i === 0) ? p1 : p2,
                            date: dateString,
                            matchday: round + 1
                        });
                    }
                }
                players.splice(1, 0, players.pop()); // Rotate array
            }
            
            leagueData.fixtures = fixtures;
            calculateTotalMatchdays();
            await saveData();
            showToast(`Generated ${fixtures.length} fixtures over ${numRounds} matchdays!`, 'success');
        }

        // Change Matchday
        function changeMatchday(delta) {
            const newMatchday = currentMatchday + delta;
            if (newMatchday < 1 || newMatchday > totalMatchdays) return;
            
            const container = document.getElementById('fixturesContainer');
            container.style.opacity = '0';
            setTimeout(() => {
                currentMatchday = newMatchday;
                document.getElementById('currentMatchday').innerText = `Matchday ${currentMatchday}`;
                updateFixtures();
                container.style.opacity = '1';
            }, 300);
        }

        // Show Player Profile
        function showPlayerProfile(id) {
            const player = leagueData.players.find(p => p.id === id);
            if (!player) { showToast('Player not found!', 'danger'); return; }

            const matches = leagueData.results.filter(r => {
                const fixture = leagueData.fixtures.find(f => f.id === r.fixtureId);
                return fixture && (fixture.player1 === id || fixture.player2 === id);
            }).sort((a,b) => b.fixtureId - a.fixtureId).map(r => {
                const fixture = leagueData.fixtures.find(f => f.id === r.fixtureId);
                const opponent = leagueData.players.find(p => p.id === (fixture.player1 === id ? fixture.player2 : fixture.player1))?.name || '...';
                const score = fixture.player1 === id ? `${r.score1} - ${r.score2}` : `${r.score2} - ${r.score1}`;
                let resultClass = r.score1 === r.score2 ? 'text-warning' : (fixture.player1 === id ? (r.score1 > r.score2) : (r.score2 > r.score1)) ? 'text-success' : 'text-danger';
                return `<li class="list-group-item bg-transparent border-secondary ${resultClass}"><strong>vs ${opponent}</strong>: ${score}</li>`;
            }).join('');

            const existingModal = document.getElementById('playerProfileModal');
            if(existingModal) { existingModal.remove(); }

            const modalEl = document.createElement('div');
            modalEl.id = 'playerProfileModal';
            modalEl.innerHTML = `
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${player.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="${player.avatar || defaultAvatar}" class="img-fluid rounded-circle mb-3 mx-auto d-block" alt="${player.name}" style="width: 150px; height: 150px; object-fit: cover; border: 4px solid var(--primary-color);">
                                <div class="row text-center bg-dark p-3 rounded" style="--bs-bg-opacity: .2;">
                                    <div class="col-3"><strong>MP</strong><br>${player.mp}</div>
                                    <div class="col-3"><strong>W</strong><br>${player.w}</div>
                                    <div class="col-3"><strong>D</strong><br>${player.d}</div>
                                    <div class="col-3"><strong>L</strong><br>${player.l}</div>
                                </div>
                                <div class="row text-center mt-3">
                                    <div class="col-4"><strong>GF</strong><br>${player.gf}</div>
                                    <div class="col-4"><strong>GA</strong><br>${player.ga}</div>
                                    <div class="col-4"><strong>GD</strong><br>${player.gd}</div>
                                </div>
                                <h4 class="text-center mt-3">Points: ${player.points}</h4>
                                <h6 class="mt-4">Recent Matches:</h6>
                                <ul class="list-group list-group-flush">${matches || '<li class="list-group-item bg-transparent border-secondary">No recorded matches.</li>'}</ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalEl);
            const modal = new bootstrap.Modal(modalEl.querySelector('.modal'));
            modal.show();
            modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
        }

        // Reset League
        async function resetLeague() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            if (confirm('Delete all league data? This cannot be undone!')) {
                leagueData = { players: [], fixtures: [], results: [] };
                currentMatchday = 1;
                totalMatchdays = 1;
                await saveData();
                populateTeamSelector();
                populateFixtureSelectors();
            }
        }

        // Import/Export
        async function importData() {
            if (!isAdmin) { showToast('Admin only!', 'danger'); return; }
            const json = document.getElementById('dataJson').value;
            if (!json) { showToast('Paste JSON data first!', 'danger'); return; }
            try {
                const data = JSON.parse(json);
                if (!data.players || !data.fixtures || !data.results) {
                    showToast('Invalid JSON structure!', 'danger'); return;
                }
                leagueData = data;
                await saveData();
                populateTeamSelector();
                populateFixtureSelectors();
                calculateTotalMatchdays();
                showToast('Data imported successfully!', 'success');
            } catch (e) {
                showToast('Invalid JSON! ' + e.message, 'danger');
            }
        }

        function exportData() {
            const json = JSON.stringify(leagueData, null, 2);
            document.getElementById('dataJson').value = json;
            document.getElementById('dataJson').select();
            try {
                navigator.clipboard.writeText(json).then(() => {
                    showToast('Data exported and copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Data exported. Copy it from the text box.', 'info');
                });
            } catch (err) {
                showToast('Data exported. Copy it from the text box.', 'info');
            }
        }
    </script>
</body>
</html>
