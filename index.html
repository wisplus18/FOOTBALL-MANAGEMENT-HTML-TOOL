<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Football Mobile League</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #00c6ff;
            --gold-accent: #ffd700;
            --stadium-green: #28a745;
            --danger-red: #dc3545;
            --grey: #6c757d;
            --bg-main: #121212;
            --bg-light: #1e1e1e;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #444;
            --hero-bg-url: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ0B2QqQBUD8Akh6MnwQcaLUBu5jg_hsiTryVPQbrG4CQ&s=10');
        }

        body[data-theme="light"] {
            --bg-main: #f0f2f5;
            --bg-light: #ffffff;
            --bg-lighter: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- Navbar --- */
        .navbar {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color) !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            font-weight: 500;
            padding: 10px 15px;
            transition: color 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: var(--primary-color);
        }
        
        #theme-toggle {
            font-size: 1.1rem;
            line-height: 1;
        }

        /* --- Hero Section --- */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)), var(--hero-bg-url);
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 100px 20px 80px 20px;
            border-bottom: 2px solid var(--primary-color);
            min-height: 400px;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 650px;
            margin: 20px auto 30px auto;
            font-weight: 300;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 12px 30px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
        }

        /* --- Section Styling --- */
        section {
            padding: 60px 0;
            transition: background-color 0.3s ease;
        }
        section:nth-of-type(odd) {
            background-color: var(--bg-light);
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 40px;
            text-align: center;
            text-transform: uppercase;
        }
        
        /* --- Card Styling --- */
        .card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .card-body {
            padding: 1.5rem;
        }

        /* --- Standings Table --- */
        .league-table {
            background-color: var(--bg-light);
            border-color: var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            overflow: hidden;
        }

        .league-table thead th {
            background-color: var(--bg-lighter);
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .league-table tbody tr:hover {
            background-color: var(--bg-lighter);
        }
        
        .league-table th, .league-table td {
            vertical-align: middle;
            padding: 0.9rem 0.75rem;
            border-bottom-color: var(--border-color);
        }
        
        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .player-name-cell img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .pos-cell { font-weight: 700; font-size: 1.1rem; width: 40px; text-align: center; }
        .pts-cell { font-weight: 700; font-size: 1.1rem; }

        .form-cell .form-bubble {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
            margin: 0 1px;
        }
        .form-bubble-W { background-color: var(--stadium-green); }
        .form-bubble-D { background-color: var(--grey); }
        .form-bubble-L { background-color: var(--danger-red); }

        .top-team-row { border-left: 4px solid var(--gold-accent); }
        .mid-team-row { border-left: 4px solid var(--primary-color); }
        .bottom-team-row { border-left: 4px solid var(--danger-red); }

        /* --- Matches Section --- */
        .matchday-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .matchday-nav h4 { color: var(--text-primary); font-weight: 500; margin: 0; width: 150px; text-align: center; }
        
        .match-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .match-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }
        .match-card.played {
            border-color: var(--stadium-green);
        }

        .match-player {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 40%;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .match-player img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-main);
        }
        .match-player:last-of-type {
            justify-content: flex-end;
            text-align: right;
        }
        
        .match-info { text-align: center; width: 20%; }
        .match-info .score { 
            font-size: 2rem; 
            font-weight: 900; 
            color: var(--text-primary); 
            letter-spacing: 2px;
        }
        .match-info .score .winner { color: var(--gold-accent); }
        .match-info .vs { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .match-info .date { font-size: 0.85rem; color: var(--text-secondary); }

        /* --- Players Section --- */
        .player-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.15);
        }
        .player-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem auto;
            border: 3px solid var(--primary-color);
            background-color: var(--bg-main);
        }
        .player-card .card-title { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }

        /* --- Modal Styling --- */
        .modal-content {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .modal-header, .modal-footer {
            border-bottom-color: var(--border-color);
            border-top-color: var(--border-color);
        }
        body[data-theme="light"] .btn-close {
            filter: none;
        }

        .form-control, .form-select {
            background-color: var(--bg-main);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-main);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .result-modal-scores { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 1rem;
            margin: 2rem 0;
        }
        .result-modal-scores input { 
            width: 80px; 
            font-size: 2rem; 
            font-weight: 700; 
            text-align: center; 
        }
        .result-modal-vs { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }

        /* --- Settings Panel --- */
        .settings-panel {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .settings-panel h5 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Toast Styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1rem; }
            .navbar-brand { font-size: 1.2rem; }
            
            .match-card { flex-direction: column; gap: 1rem; padding: 1rem; }
            .match-player { width: 100%; font-size: 1rem; }
            .match-player:last-of-type { justify-content: flex-start; text-align: left; }
            .match-info { width: 100%; display: flex; justify-content: space-between; align-items: center; }
            .match-info .score { font-size: 1.8rem; }
            .match-info .vs { order: 2; }
            .match-info .date { order: 1; }
            
            .table-responsive { border-radius: 10px; }
            .table { font-size: 0.85rem; }
            .player-name-cell img { width: 30px; height: 30px; }
            
            .table th:nth-child(7), .table td:nth-child(7), /* GF */
            .table th:nth-child(8), .table td:nth-child(8), /* GA */
            .table th:nth-child(10), .table td:nth-child(10) /* Form */
            {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="#007bff">
                    <path d="M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM76.4,26.66l-6.85,6.85a28,28,0,0,1-13.7,11.37L50,50,44.15,44.88a28,28,0,0,1-11.37-13.7L25.93,23.6A38.56,38.56,0,0,1,50,11.5a38.16,38.16,0,0,1,26.4,15.16ZM23.6,74.07l6.85-6.85a28,28,0,0,1,13.7-11.37L50,50,55.85,55.12a28,28,0,0,1,11.37,13.7l6.85,6.85A38.56,38.56,0,0,1,50,88.5,38.16,38.16,0,0,1,23.6,74.07Z"/>
                </svg>
                E-FOOTBALL LEAGUE
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#standings">Standings</a></li>
                    <li class="nav-item"><a class="nav-link" href="#matches">Matches</a></li>
                    <li class="nav-item"><a class="nav-link" href="#players">Players</a></li>
                    <li class="nav-item">
                        <button class="btn nav-link" id="theme-toggle" aria-label="Toggle theme">
                            <i class="fa-solid fa-sun"></i>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary ms-2" onclick="showSettings()">
                            <i class="fa-solid fa-gear me-1"></i> Settings
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="hero">
        <div class="container">
            <h1>EFOOTBALL LEAGUE SEASON 1</h1>
            <p>Welcome to the Competitive E-Football League</p>
            <a href="#standings" class="btn btn-primary">View Standings</a>
        </div>
    </section>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">League Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="mb-3">Manage Players</h6>
                        <div class="mb-3">
                            <label for="playerName" class="form-label">Player Name</label>
                            <input type="text" id="playerName" class="form-control" placeholder="Enter player name">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="addPlayer()">
                                <i class="fa-solid fa-user-plus me-1"></i> Add Player
                            </button>
                            <button class="btn btn-danger" onclick="removeSelectedPlayer()">
                                <i class="fa-solid fa-user-minus me-1"></i> Remove Selected Player
                            </button>
                        </div>
                        <div class="mt-3">
                            <label for="playerSelect" class="form-label">Select Player</label>
                            <select id="playerSelect" class="form-select"></select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="mb-3">Generate Fixtures</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="generateFixtures('single')">
                                <i class="fa-solid fa-calendar me-1"></i> Single Round Robin
                            </button>
                            <button class="btn btn-info" onclick="generateFixtures('double')">
                                <i class="fa-solid fa-calendar-alt me-1"></i> Double Round Robin
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3">League Management</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="resetLeague()">
                                <i class="fa-solid fa-trash me-1"></i> Reset League
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter Match Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resultFixtureId">
                    <div class="text-center mb-3">
                        <h6 id="resultModalPlayer1Name">Player 1</h6>
                    </div>
                    <div class="result-modal-scores">
                        <input type="number" id="resultScore1" class="form-control" min="0" value="0">
                        <span class="result-modal-vs">-</span>
                        <input type="number" id="resultScore2" class="form-control" min="0" value="0">
                    </div>
                    <div class="text-center mt-3">
                        <h6 id="resultModalPlayer2Name">Player 2</h6>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitResult()">Save Result</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Avatar Modal -->
    <div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Player Avatar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="avatarPlayerId">
                    <div class="mb-3">
                        <label class="form-label">Choose image from gallery</label>
                        <input type="file" id="avatarFile" class="form-control" accept="image/*" capture="environment">
                        <small class="text-muted">Select an image from your device</small>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary" onclick="uploadAvatar()">
                            <i class="fa-solid fa-upload me-1"></i> Set Avatar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section id="standings" class="py-5">
        <div class="container">
            <h2 class="section-title">Standings</h2>
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table league-table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" class="pos-cell">#</th>
                                    <th scope="col" style="width: 30%;">Player</th>
                                    <th scope="col">MP</th>
                                    <th scope="col">W</th>
                                    <th scope="col">D</th>
                                    <th scope="col">L</th>
                                    <th scope="col">GF</th>
                                    <th scope="col">GA</th>
                                    <th scope="col">GD</th>
                                    <th scope="col" class="form-cell">Form</th>
                                    <th scope="col" class="pts-cell">Pts</th>
                                </tr>
                            </thead>
                            <tbody id="standingsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="matches" class="py-5">
        <div class="container">
            <h2 class="section-title">Matches</h2>
            <div class="matchday-nav">
                <button class="btn btn-primary" onclick="changeMatchday(-1)">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h4 id="currentMatchday">Matchday 1</h4>
                <button class="btn btn-primary" onclick="changeMatchday(1)">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            <div id="matchesContainer"></div>
        </div>
    </section>

    <section id="players" class="py-5">
        <div class="container">
            <h2 class="section-title">Players</h2>
            <div class="row" id="playersContainer"></div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Default avatar (SVG data URL)
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%236c757d'%3E%3Cpath d='M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM50,15A35,35,0,1,1,15,50,35,35,0,0,1,50,15ZM50,25A10,10,0,1,1,40,35,10,10,0,0,1,50,25ZM50,80a27,27,0,0,1-25-12.87c.2-8.3,16.72-12.93,25-12.93s24.8,4.63,25,12.93A27,27,0,0,1,50,80Z'/%3E%3C/svg%3E";

        // League data stored locally
        let leagueData = {
            players: [],
            fixtures: [],
            results: [],
            settings: {
                currentMatchday: 1,
                totalMatchdays: 1
            }
        };

        // Current matchday
        let currentMatchday = 1;
        let totalMatchdays = 1;

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('efootballLeague');
            if (saved) {
                leagueData = JSON.parse(saved);
                currentMatchday = leagueData.settings.currentMatchday || 1;
                totalMatchdays = leagueData.settings.totalMatchdays || 1;
            }
            updateAllViews();
        }

        // Save data to localStorage
        function saveData() {
            leagueData.settings.currentMatchday = currentMatchday;
            leagueData.settings.totalMatchdays = totalMatchdays;
            localStorage.setItem('efootballLeague', JSON.stringify(leagueData));
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" data-bs-delay="3000">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            const container = document.getElementById('toast-container');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = toastHtml;
            const toastEl = wrapper.firstChild;
            container.appendChild(toastEl);
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.dataset.theme = 'light';
                themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('theme', 'light');
            } else {
                delete document.body.dataset.theme;
                themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
                localStorage.setItem('theme', 'dark');
            }
        }
        themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // Update all views
        function updateAllViews() {
            updateStandings();
            updateMatches();
            updatePlayers();
            populatePlayerSelect();
            calculateTotalMatchdays();
        }

        // Calculate total matchdays
        function calculateTotalMatchdays() {
            const matchdays = leagueData.fixtures.map(f => f.matchday);
            totalMatchdays = matchdays.length > 0 ? Math.max(...matchdays) : 1;
            if (currentMatchday > totalMatchdays) {
                currentMatchday = totalMatchdays;
            }
            document.getElementById('currentMatchday').textContent = `Matchday ${currentMatchday}`;
        }

        // Recalculate standings
        function recalculateStandings() {
            // Reset all player stats
            leagueData.players.forEach(player => {
                player.mp = 0; player.w = 0; player.d = 0; player.l = 0;
                player.gf = 0; player.ga = 0; player.gd = 0; player.pts = 0; player.form = [];
            });

            // Process all results
            leagueData.results.forEach(result => {
                const p1 = leagueData.players.find(p => p.id === result.player1Id);
                const p2 = leagueData.players.find(p => p.id === result.player2Id);

                if (!p1 || !p2) return;

                // Update Player 1
                p1.mp++; p1.gf += result.score1; p1.ga += result.score2;
                if (result.score1 > result.score2) {
                    p1.w++; p1.pts += 3; p1.form.unshift('W');
                } else if (result.score1 < result.score2) {
                    p1.l++; p1.form.unshift('L');
                } else {
                    p1.d++; p1.pts += 1; p1.form.unshift('D');
                }

                // Update Player 2
                p2.mp++; p2.gf += result.score2; p2.ga += result.score1;
                if (result.score2 > result.score1) {
                    p2.w++; p2.pts += 3; p2.form.unshift('W');
                } else if (result.score2 < result.score1) {
                    p2.l++; p2.form.unshift('L');
                } else {
                    p2.d++; p2.pts += 1; p2.form.unshift('D');
                }
            });

            // Keep only last 5 form results and calculate GD
            leagueData.players.forEach(player => {
                player.form = player.form.slice(0, 5);
                player.gd = player.gf - player.ga;
            });
        }

        // Update standings table
        function updateStandings() {
            recalculateStandings();
            const tableBody = document.getElementById('standingsTable');
            tableBody.innerHTML = '';

            // Sort players
            const sortedPlayers = [...leagueData.players].sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;
                if (b.gf !== a.gf) return b.gf - a.gf;
                return a.name.localeCompare(b.name);
            });

            sortedPlayers.forEach((player, index) => {
                let rowClass = '';
                if (index < 3) rowClass = 'top-team-row';
                else if (index >= sortedPlayers.length - 3) rowClass = 'bottom-team-row';

                const formHtml = player.form.map(f => 
                    `<span class="form-bubble form-bubble-${f}">${f}</span>`
                ).join('');

                const row = `
                    <tr class="${rowClass}">
                        <td class="pos-cell">${index + 1}</td>
                        <td class="player-name-cell">
                            <img src="${player.avatar || defaultAvatar}" alt="${player.name}" onclick="changeAvatar('${player.id}')" style="cursor: pointer;">
                            <span>${player.name}</span>
                        </td>
                        <td>${player.mp}</td>
                        <td>${player.w}</td>
                        <td>${player.d}</td>
                        <td>${player.l}</td>
                        <td>${player.gf}</td>
                        <td>${player.ga}</td>
                        <td>${player.gd}</td>
                        <td class="form-cell">${formHtml}</td>
                        <td class="pts-cell">${player.pts}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Update matches display
        function updateMatches() {
            const container = document.getElementById('matchesContainer');
            container.innerHTML = '';

            const matches = leagueData.fixtures
                .filter(f => f.matchday === currentMatchday)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-secondary py-4">
                        <i class="fa-solid fa-calendar-xmark fa-3x mb-3"></i>
                        <p>No matches scheduled for this matchday.</p>
                    </div>
                `;
                return;
            }

            matches.forEach(fixture => {
                const p1 = leagueData.players.find(p => p.id === fixture.player1Id);
                const p2 = leagueData.players.find(p => p.id === fixture.player2Id);
                const result = leagueData.results.find(r => r.fixtureId === fixture.id);

                if (!p1 || !p2) return;

                const dateDisplay = fixture.date.includes('TBD') ? fixture.date : new Date(fixture.date).toLocaleDateString();
                const isPlayed = !!result;
                const cardClass = isPlayed ? 'match-card played' : 'match-card';

                let scoreHtml = `<span class="vs">VS</span>`;
                if (isPlayed) {
                    const winner1Class = result.score1 > result.score2 ? 'winner' : '';
                    const winner2Class = result.score2 > result.score1 ? 'winner' : '';
                    scoreHtml = `
                        <div class="score">
                            <span class="${winner1Class}">${result.score1}</span> - 
                            <span class="${winner2Class}">${result.score2}</span>
                        </div>
                    `;
                }

                const card = `
                    <div class="${cardClass}" onclick="showResultModal('${fixture.id}')">
                        <div class="match-player">
                            <img src="${p1.avatar || defaultAvatar}" alt="${p1.name}">
                            <span>${p1.name}</span>
                        </div>
                        <div class="match-info">
                            ${scoreHtml}
                            <span class="date">${dateDisplay}</span>
                        </div>
                        <div class="match-player">
                            <span>${p2.name}</span>
                            <img src="${p2.avatar || defaultAvatar}" alt="${p2.name}">
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // Update players display
        function updatePlayers() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';

            if (leagueData.players.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fa-solid fa-users fa-3x mb-3 text-secondary"></i>
                        <p class="text-secondary">No players added yet. Use Settings to add players.</p>
                    </div>
                `;
                return;
            }

            leagueData.players.forEach(player => {
                const card = `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-4">
                        <div class="player-card">
                            <img src="${player.avatar || defaultAvatar}" alt="${player.name}" 
                                 onclick="changeAvatar('${player.id}')" style="cursor: pointer;">
                            <h5 class="card-title">${player.name}</h5>
                            <p class="card-text">${player.pts} PTS | ${player.mp} Played</p>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // Populate player select dropdown
        function populatePlayerSelect() {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">Select a player...</option>';
            leagueData.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                select.appendChild(option);
            });
        }

        // Change matchday
        function changeMatchday(direction) {
            const newMatchday = currentMatchday + direction;
            if (newMatchday >= 1 && newMatchday <= totalMatchdays) {
                currentMatchday = newMatchday;
                document.getElementById('currentMatchday').textContent = `Matchday ${currentMatchday}`;
                updateMatches();
                saveData();
            }
        }

        // Show settings modal
        function showSettings() {
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        }

        // Add player
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('Please enter a player name', 'danger');
                return;
            }

            if (leagueData.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('Player already exists', 'warning');
                return;
            }

            const newPlayer = {
                id: Date.now().toString(),
                name: name,
                avatar: defaultAvatar,
                mp: 0, w: 0, d: 0, l: 0,
                gf: 0, ga: 0, gd: 0, pts: 0, form: []
            };

            leagueData.players.push(newPlayer);
            nameInput.value = '';
            saveData();
            updateAllViews();
            showToast(`Player "${name}" added successfully!`, 'success');
        }

        // Remove selected player
        function removeSelectedPlayer() {
            const select = document.getElementById('playerSelect');
            const playerId = select.value;

            if (!playerId) {
                showToast('Please select a player to remove', 'warning');
                return;
            }

            const player = leagueData.players.find(p => p.id === playerId);
            if (!player) return;

            if (confirm(`Remove ${player.name}? This will also delete all their matches and results.`)) {
                // Remove player
                leagueData.players = leagueData.players.filter(p => p.id !== playerId);
                
                // Remove fixtures involving this player
                leagueData.fixtures = leagueData.fixtures.filter(f => 
                    f.player1Id !== playerId && f.player2Id !== playerId
                );
                
                // Remove results involving this player
                leagueData.results = leagueData.results.filter(r => 
                    r.player1Id !== playerId && r.player2Id !== playerId
                );
                
                saveData();
                updateAllViews();
                showToast(`Player "${player.name}" removed`, 'success');
            }
        }

        // Generate fixtures
        function generateFixtures(type) {
            if (leagueData.players.length < 2) {
                showToast('Need at least 2 players to generate fixtures', 'warning');
                return;
            }

            // Clear existing fixtures and results
            leagueData.fixtures = [];
            leagueData.results = [];

            const players = leagueData.players.map(p => p.id);
            let numRounds = type === 'double' ? (players.length - 1) * 2 : players.length - 1;
            
            // Generate round robin schedule
            for (let round = 1; round <= numRounds; round++) {
                for (let i = 0; i < players.length / 2; i++) {
                    const p1 = players[i];
                    const p2 = players[players.length - 1 - i];
                    
                    if (p1 && p2) {
                        const homeId = round % 2 === 1 ? p1 : p2;
                        const awayId = round % 2 === 1 ? p2 : p1;

                        const fixture = {
                            id: `${Date.now()}-${round}-${i}`,
                            player1Id: homeId,
                            player2Id: awayId,
                            date: `Matchday ${round}`,
                            matchday: round,
                            isPlayed: false
                        };
                        leagueData.fixtures.push(fixture);
                    }
                }
                
                // Rotate players
                players.splice(1, 0, players.pop());
            }

            currentMatchday = 1;
            saveData();
            updateAllViews();
            showToast(`${type === 'double' ? 'Double' : 'Single'} round robin fixtures generated!`, 'success');
        }

        // Show result modal
        function showResultModal(fixtureId) {
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) return;

            const p1 = leagueData.players.find(p => p.id === fixture.player1Id);
            const p2 = leagueData.players.find(p => p.id === fixture.player2Id);
            const existingResult = leagueData.results.find(r => r.fixtureId === fixtureId);

            document.getElementById('resultFixtureId').value = fixtureId;
            document.getElementById('resultModalPlayer1Name').textContent = p1.name;
            document.getElementById('resultModalPlayer2Name').textContent = p2.name;
            
            if (existingResult) {
                document.getElementById('resultScore1').value = existingResult.score1;
                document.getElementById('resultScore2').value = existingResult.score2;
            } else {
                document.getElementById('resultScore1').value = 0;
                document.getElementById('resultScore2').value = 0;
            }

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }

        // Submit result
        function submitResult() {
            const fixtureId = document.getElementById('resultFixtureId').value;
            const score1 = parseInt(document.getElementById('resultScore1').value);
            const score2 = parseInt(document.getElementById('resultScore2').value);
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showToast('Please enter valid scores', 'danger');
                return;
            }

            if (!fixture) return;

            // Remove existing result if any
            leagueData.results = leagueData.results.filter(r => r.fixtureId !== fixtureId);

            // Add new result
            const result = {
                fixtureId: fixtureId,
                player1Id: fixture.player1Id,
                player2Id: fixture.player2Id,
                score1: score1,
                score2: score2,
                timestamp: Date.now()
            };
            leagueData.results.push(result);

            saveData();
            updateAllViews();
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
            showToast('Result saved!', 'success');
        }

        // Change player avatar
        function changeAvatar(playerId) {
            document.getElementById('avatarPlayerId').value = playerId;
            const modal = new bootstrap.Modal(document.getElementById('avatarModal'));
            modal.show();
        }

        // Upload avatar from gallery
        function uploadAvatar() {
            const playerId = document.getElementById('avatarPlayerId').value;
            const fileInput = document.getElementById('avatarFile');
            
            if (!playerId || !fileInput.files.length) {
                showToast('Please select an image', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const player = leagueData.players.find(p => p.id === playerId);
                if (player) {
                    player.avatar = e.target.result;
                    saveData();
                    updateAllViews();
                    showToast('Avatar updated!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('avatarModal')).hide();
                    fileInput.value = '';
                }
            };

            reader.readAsDataURL(file);
        }

        // Reset league
        function resetLeague() {
            if (confirm('WARNING: This will delete ALL players, fixtures, and results. Continue?')) {
                leagueData = {
                    players: [],
                    fixtures: [],
                    results: [],
                    settings: {
                        currentMatchday: 1,
                        totalMatchdays: 1
                    }
                };
                currentMatchday = 1;
                saveData();
                updateAllViews();
                showToast('League reset successfully', 'info');
                bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            
            // Load data
            loadData();
            
            // Add some sample data if empty
            if (leagueData.players.length === 0) {
                leagueData.players = [
                    {
                        id: '1',
                        name: 'Player 1',
                        avatar: defaultAvatar,
                        mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0, form: []
                    },
                    {
                        id: '2',
                        name: 'Player 2',
                        avatar: defaultAvatar,
                        mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0, form: []
                    }
                ];
                saveData();
                updateAllViews();
            }
        });
    </script>
</body>
</html>