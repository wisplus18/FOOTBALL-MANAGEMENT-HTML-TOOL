<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>E-Football Tournament</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        /* PERMANENT LIGHT THEME VARIABLES */
        :root {
            --primary-color: #008f5a; 
            --secondary-color: #00b371;
            --danger-red: #ff4d4d;
            
            --bg-main: #f0f2f5;
            --bg-light: #ffffff;
            --bg-lighter: #f8f9fa;
            
            --text-primary: #181818;
            --text-secondary: #555555;
            
            --border-color: #dee2e6;
            --hero-bg-url: url('stadium.jpg'); 
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: 0.3s; overflow-x: hidden; min-height: 100vh; padding-bottom: 70px; }
        
        /* Navbar */
        .custom-navbar { background-color: var(--bg-light); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; padding: 0.5rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .custom-nav-container { display: flex; align-items: center; padding: 0 15px; gap: 15px; overflow-x: auto; white-space: nowrap; }
        .custom-nav-brand { font-size: 1.2rem; font-weight: 900; color: var(--primary-color); margin-right: 15px; text-decoration: none; }
        .custom-nav-item { color: var(--text-secondary); font-weight: 500; text-decoration: none; padding: 8px 12px; border-radius: 20px; transition: 0.3s; font-size: 0.9rem; text-transform: uppercase; }
        .custom-nav-item:hover, .custom-nav-item.active { background-color: rgba(0, 143, 90, 0.1); color: var(--primary-color); }

        /* Hero Section - UPDATED for White Text */
        .hero { 
            /* Dark overlay to make white text pop */
            background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.8)), var(--hero-bg-url); 
            background-size: cover; 
            background-position: center; 
            color: #ffffff; 
            text-align: center; 
            padding: 80px 20px; 
            border-bottom: 4px solid var(--primary-color); 
            transition: background-image 0.5s ease-in-out; 
        }
        .hero h1 { 
            font-size: 2.5rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            color: #ffffff; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* ADS SYSTEM STYLES */
        .ads-section { background: var(--bg-light); padding: 15px 0; border-bottom: 1px solid var(--border-color); overflow: hidden; position: relative; min-height: 120px; display: flex; align-items: center; }
        .ad-container { width: 100%; max-width: 800px; margin: 0 auto; text-align: center; animation: fadeInAd 0.5s ease-in-out; }
        @keyframes fadeInAd { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ad-content { display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .ad-image { max-height: 180px; max-width: 520px; border-radius: 5px; object-fit: contain; background: white; padding: 2px; border: 1px solid var(--border-color); }
        .ad-text h5 { margin: 0; color: var(--primary-color); font-weight: 700; font-size: 1.1rem; }
        .ad-text p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-ads-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        .mini-ad { background: var(--bg-light); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 4px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; max-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mini-ad:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .mini-ad img { width: 60px; height: 80px; object-fit: contain; border-radius: 2px; }
        .mini-ad span { font-size: 0.75rem; color: var(--text-secondary); font-weight: bold; }

        /* General UI */
        .section-title { color: var(--primary-color); font-weight: 700; font-size: 1.8rem; margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .card { background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .nav-pills .nav-link { color: var(--text-secondary); background-color: var(--bg-lighter); margin: 0 5px; border: 1px solid var(--border-color); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; font-weight: 700; border-color: var(--primary-color); }
        
        /* League Table */
        .league-table { background-color: var(--bg-light); color: var(--text-primary); }
        .league-table thead th { background-color: var(--bg-lighter); color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        .league-table td { border-bottom-color: var(--border-color); vertical-align: middle; }
        .group-nav { display: flex; justify-content: space-between; align-items: center; background: var(--bg-lighter); padding: 10px; border-radius: 8px 8px 0 0; border: 1px solid var(--border-color); border-bottom: none; }
        .group-title { font-weight: 900; font-size: 1.5rem; color: var(--primary-color); text-transform: uppercase; margin: 0; }

        /* Matches */
        .match-card { background-color: var(--bg-light); border-radius: 15px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; position: relative; border-left: 5px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); border-left-width: 5px; }
        .match-card.knockout { border-left-color: var(--danger-red); background: linear-gradient(90deg, rgba(255, 77, 77, 0.05), transparent); }
        .match-player img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin: 0 5px; border: 2px solid var(--border-color); }
        .match-player { display: flex; align-items: center; width: 35%; font-size: 0.9rem; font-weight: 500; }
        .match-center { width: 30%; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .match-score { font-size: 1.4rem; font-weight: 900; letter-spacing: 2px; }
        
        /* Helper Classes */
        .admin-mode, .sub-admin-mode { display: none; }
        .contact-btn { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 2px; color: white; text-decoration: none; font-size: 0.7rem; }
        .btn-wa { background-color: #25D366; } .btn-call { background-color: #007bff; }
        .btn-xs { padding: 1px 5px; font-size: 0.7rem; }
        .instruction-box { font-size: 0.85rem; line-height: 1.4; border-left: 4px solid var(--primary-color) !important; text-align: left; }

        @media (max-width: 768px) {
            .match-player { flex-direction: column; text-align: center; gap: 5px; width: 30%; }
            .match-player img { width: 40px; height: 40px; }
            .match-card { padding: 10px 5px; }
            .match-center { width: 40%; }
        }
    </style>
</head>
<body>

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 1100;"></div>

    <nav class="custom-navbar">
        <div class="custom-nav-container">
            <a href="#" class="custom-nav-brand"><i class="fa-solid fa-futbol me-2"></i> TOURNAMENT</a>
            <a href="#league-section" class="custom-nav-item active"><i class="fa-solid fa-layer-group"></i> Tournament</a>
            <a href="#players" class="custom-nav-item"><i class="fa-solid fa-users"></i> Players</a>
            <a href="#trophyRoom" class="custom-nav-item"><i class="fa-solid fa-award"></i> History</a>
            
            <button class="btn btn-sm btn-outline-primary ms-auto" id="admin-login-button"><i class="fa-solid fa-lock"></i></button>
            <button class="btn btn-sm btn-outline-danger ms-2 admin-mode" onclick="showPendingModal()">
                <i class="fa-solid fa-inbox"></i> <span id="pendingCountBadge" class="badge bg-danger rounded-pill" style="display:none">0</span>
            </button>
        </div>
    </nav>

    <div id="liveTicker" style="background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: white; padding: 5px; font-weight: 700; white-space: nowrap; overflow: hidden;">
        <span class="live-ticker-content" id="tickerContent" style="display: inline-block; animation: tickerSlide 35s linear infinite;">Loading...</span>
    </div>
    <style>@keyframes tickerSlide { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }</style>

    <section class="hero">
        <div class="container">
            <h1 id="heroTitle">LOADING...</h1>
            <p class="lead text-white" style="font-weight: 500;">GROUP STAGE & KNOCKOUT TOURNAMENT</p>
        </div>
    </section>

    <section class="ads-section" id="mainAdsSection">
        <div class="ad-container" id="adContainer">
            </div>
    </section>

    <section id="league-section" class="py-5">
        <div class="container">
            
            <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-standings"><i class="fa-solid fa-list-ol me-1"></i> Standings</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-fixtures"><i class="fa-solid fa-calendar-days me-1"></i> Matches</button></li>
            </ul>

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="pills-standings">
                    
                    <div id="standings-mini-ads" class="mini-ads-row"></div>

                    <div class="card p-0 mb-4 border-0">
                        <div class="group-nav">
                            <button class="btn btn-outline-secondary" onclick="switchGroupView('prev')"><i class="fa-solid fa-chevron-left"></i></button>
                            <h3 class="group-title" id="groupTitleDisplay">GROUP A</h3>
                            <button class="btn btn-outline-secondary" onclick="switchGroupView('next')"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table league-table table-striped mb-0">
                                <thead><tr><th>#</th><th>Player</th><th>MP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead>
                                <tbody id="standingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="admin-mode text-center">
                        <button class="btn btn-sm btn-primary m-1" onclick="showAddPlayerModal()">Add Player</button>
                        <button class="btn btn-sm btn-info m-1 text-white" onclick="showEditBackgroundModal()">Set BG</button>
                        <button class="btn btn-sm btn-danger m-1" onclick="endSeasonManual()">End Season</button>
                        <button class="btn btn-sm btn-warning m-1" onclick="generateSeason('double')">Re-Generate Groups (Double)</button>
                        <button class="btn btn-sm btn-warning m-1" onclick="generateKnockouts()">Start Knockouts</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-fixtures">
                    
                    <div id="fixtures-mini-ads" class="mini-ads-row"></div>

                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <button class="btn btn-sm btn-primary" onclick="changeMatchday(-1)"><i class="fa-solid fa-arrow-left"></i></button>
                        <h4 id="currentMatchdayDisplay" class="m-0 text-uppercase text-dark">Matchday 1</h4>
                        <button class="btn btn-sm btn-primary" onclick="changeMatchday(1)"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>

                    <div id="fixturesContainer"></div>

                    <div class="admin-mode mt-4 text-center">
                        <button class="btn btn-primary m-1" onclick="showAddFixtureModal()">Add Fixture</button>
                        <button class="btn btn-info m-1 text-white" onclick="openGenerateModal()">Auto-Generate Groups</button>
                        <button class="btn btn-danger m-1" onclick="forceAutoForfeits()">Force Auto-Resolve</button>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <section id="players" class="py-5 bg-white">
        <div class="container">
            <h2 class="section-title">Players</h2>
             <div id="players-mini-ads" class="mini-ads-row"></div>
            <div class="row row-cols-2 row-cols-md-4 g-4" id="playersContainer"></div>
        </div>
    </section>

    <section id="trophyRoom" class="py-5">
        <div class="container">
            <h2 class="section-title text-warning"><i class="fa-solid fa-award"></i> Hall of Fame</h2>
            <div class="d-flex justify-content-center mb-3" id="trophySeasonTabs"></div>
            <div id="trophyContainer"></div>
        </div>
    </section>

    <div class="modal fade" id="adModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--bg-light); color: var(--text-primary); border: 1px solid var(--primary-color);">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="adModalTitle">Sponsor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="adModalImg" src="" class="img-fluid rounded mb-3" style="max-height: 200px; display:none;">
                    <p id="adModalDesc" class="mb-4"></p>
                    <div id="adModalLinks" class="d-grid gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Admin Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="password" id="adminPassword" class="form-control" placeholder="Enter Password"></div><div class="modal-footer"><button class="btn btn-primary" onclick="loginAdmin()">Login</button></div></div></div></div>
    
    <div class="modal fade" id="generateLeagueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Generate Groups</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>System will shuffle players into Group A and Group B (Max 4 each).</p><button class="btn btn-primary w-100 mb-2" onclick="generateSeason('double')">Double Round (Home & Away)</button><button class="btn btn-secondary w-100" onclick="generateSeason('single')">Single Round (1 Match)</button></div></div></div></div>

    <div class="modal fade" id="resultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enter Result</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="hidden" id="resultMatchId"><div class="d-flex justify-content-center align-items-center gap-2"><label id="resultPlayer1Name">P1</label><input type="number" id="resultScore1" class="form-control w-25 text-center"><span class="fw-bold">VS</span><input type="number" id="resultScore2" class="form-control w-25 text-center"><label id="resultPlayer2Name">P2</label></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitResult()">Submit</button></div></div></div></div>

    <div class="modal fade" id="playerSubmitModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Submit Result</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="hidden" id="ps_fixtureId"><div class="mb-2 text-start"><small class="text-muted">Confirm teams:</small></div><select id="ps_homeSelect" class="form-select mb-2"></select><select id="ps_awaySelect" class="form-select mb-2"></select><div class="d-flex justify-content-center gap-2"><input type="number" id="ps_score1" class="form-control w-25 text-center" placeholder="0"><span class="fw-bold align-self-center">VS</span><input type="number" id="ps_score2" class="form-control w-25 text-center" placeholder="0"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitPlayerResult()">Submit Result</button></div></div></div></div>

    <div class="modal fade" id="pendingModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Pending Results</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-end mb-2"><button class="btn btn-success fw-bold" onclick="approveAllPending()">APPROVE ALL</button></div><div id="pendingListContent" style="max-height: 50vh; overflow-y: auto;"></div></div></div></div></div>

    <div class="modal fade" id="sessionTeamModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-circle-info"></i> Welcome / Karibu</h5>
                </div>
                <div class="modal-body">
                    <div class="instruction-box mb-3 p-2 border rounded bg-light">
                        <p class="mb-1"><strong>English:</strong> Select your team name from the list below to enable the "Submit Results" feature for your matches. If you are just visiting, click "View Only".</p>
                        <hr class="my-1">
                        <p class="mb-0 text-muted"><strong>Swahili:</strong> Chagua jina la timu yako kwenye orodha hapa chini ili uweze kutuma matokeo ya mechi zako. Kama unakuja kuangalia tu, bonyeza "View Only".</p>
                    </div>
                    <select id="sessionTeamSelect" class="form-select mb-3">
                        <option value="">-- Choose Your Team / Chagua Timu --</option>
                    </select>
                    <button class="btn btn-primary w-100 fw-bold" onclick="setSessionTeam()">SET MY TEAM / CHAGUA</button>
                    <button class="btn btn-link w-100 mt-2 text-decoration-none text-muted" onclick="skipSessionTeam()">View Only / Angalia Tu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addPlayerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Player</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="playerName" class="form-control mb-2" placeholder="Name"><input type="url" id="playerAvatarUrl" class="form-control mb-2" placeholder="Avatar URL"><input type="url" id="playerSocialLink" class="form-control mb-2" placeholder="WhatsApp Link"><input type="tel" id="playerPhone" class="form-control" placeholder="Phone Number"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitPlayer()">Add</button></div></div></div></div>
    
    <div class="modal fade" id="editPlayerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Player</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editPlayerId"><input type="text" id="editPlayerName" class="form-control mb-2" placeholder="Name"><input type="url" id="editPlayerAvatarUrl" class="form-control mb-2" placeholder="Avatar URL"><input type="url" id="editPlayerSocialLink" class="form-control mb-2" placeholder="WhatsApp Link"><input type="tel" id="editPlayerPhone" class="form-control" placeholder="Phone Number"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitEditPlayer()">Save Changes</button></div></div></div></div>

    <div class="modal fade" id="editBackgroundModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Background</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="url" id="backgroundUrl" class="form-control" placeholder="Image URL"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitBackground()">Save</button></div></div></div></div>
    
    <div class="modal fade" id="addFixtureModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Fixture</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="fixturePlayer1" class="form-select mb-2"></select><select id="fixturePlayer2" class="form-select mb-2"></select><input type="date" id="fixtureDate" class="form-control mb-2"><input type="number" id="fixtureMatchday" class="form-control" placeholder="Matchday" value="1"><select id="fixtureStage" class="form-select"><option value="group">Group Stage</option><option value="Semi-Final">Semi-Final</option><option value="Final">Final</option></select></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitFixture()">Add</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- ADS CONFIGURATION ---
        const ADS_CONFIG = [
            {
                id: 1,
                name: "INTERNET KITONGA ðŸ”¥",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ_3Kz3CPWYrxcMICkT184B-P9EM5KPF8ihIHK94JAV1A&s=10",
                desc: "Karbu ujipatie mabando ya bei chei , pesa kidogo GB kama zoote ðŸ‘‘ muda wowote , n Mwezi hadu mwaka mzima ðŸ”¥",
                contact: {
                    whatsapp: "https://wa.me/255755532988",
                  //  phone: "+255755532988",
                    //website: 
                }
            },
            {
                id: 2,
                name: "BE THE KINGðŸ‘‘",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSDOERUVozLhGlVdLNdkGFQDaQHKfutKTK1SDMbKPU-oIG_m6VW_wL5DhF-&s=10",
                desc: " Usipoteze pesa ndefu kununua mabando madogo madogo kila sku ðŸ”¥âœ¨",
                contact: {
                whatsapp: "https://wa.me/255755532988",
              //  phone: "+255755532988",
                    //website: "https://example.com/energy"
                    }
                },
            {
                id: 3,
                name: "USITESEKE TENA KIFURUSHI CHOCHOTEðŸ”¥",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSO30HKcvvG8JLTdLGJhY-nU_760KEo4DTRCLfSr5wip8Gy7KggTao2BIw&s=10",
                desc: " Kifurushi chochote , dakika , sms , GB  etc vyote vya MWEZ MZIMA HATA MWAKA UKITAKAðŸ”¥âœ¨",
                contact: {
                whatsapp: "https://wa.me/255755532988",
                phone: "+255755532988",
                    //website: "https://example.com/energy"
                }
            }
        ];

        // --- FIREBASE SETUP ---
        const firebaseConfig = { apiKey: "AIzaSyCLycBxpQ3MMIDLYjmBqMZv32FIu2eDXF4", authDomain: "efootball-app-ce90b.firebaseapp.com", projectId: "efootball-app-ce90b", storageBucket: "efootball-app-ce90b.firebasestorage.app", messagingSenderId: "387933114333", appId: "1:387933114333:web:1c85dbadacf70d0406b034" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- STATE MANAGEMENT ---
        let appData = { 
            season: 1, 
            history: [], 
            players: [], 
            fixtures: [], 
            results: [], 
            resultsPending: [],
            backgroundUrl: 'url("stadium.jpg")',
            currentStage: 'group' 
        };

        let currentGroupView = 'A';
        let currentMatchdayIndex = 1; 
        let currentAdIndex = 0;
        let sessionTeamId = null;
        let isAdmin = false;
        let password = "Genie";
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%236c757d'%3E%3Cpath d='M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM50,20c11,0,20,9,20,20S61,60,50,60,30,51,30,40,39,20,50,20Zm0,70C34,90,20,80,20,65c0-10,15-20,30-20s30,10,30,20C80,80,66,90,50,90Z'/%3E%3C/svg%3E";

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            setupAds();
            loadData();
            document.getElementById('admin-login-button').addEventListener('click', () => new bootstrap.Modal(document.getElementById('adminModal')).show());
        });

        // --- ADS ENGINE ---
        function setupAds() {
            renderMainAd();
            renderMiniAds();
            setInterval(() => {
                currentAdIndex = (currentAdIndex + 1) % ADS_CONFIG.length;
                renderMainAd();
            }, 4000);
        }

        function renderMainAd() {
            const ad = ADS_CONFIG[currentAdIndex];
            if(!ad) return;
            const container = document.getElementById('adContainer');
            container.style.animation = 'none';
            container.offsetHeight; 
            container.style.animation = null; 
            
            container.innerHTML = `
                <div class="ad-content">
                    <img src="${ad.image}" class="ad-image" alt="${ad.name}">
                    <div class="ad-text text-start">
                        <h5>${ad.name} <span class="badge bg-warning text-dark" style="font-size:0.9rem">Main Sponsor</span></h5>
                        <p>${ad.desc}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="openAdModal(${ad.id})">Read More</button>
                </div>
            `;
        }

        function renderMiniAds() {
            const targets = ['standings-mini-ads', 'fixtures-mini-ads', 'players-mini-ads'];
            targets.forEach(tid => {
                const el = document.getElementById(tid);
                if(!el) return;
                el.innerHTML = '';
                ADS_CONFIG.slice(0,3).forEach(ad => {
                    el.innerHTML += `
                        <div class="mini-ad" onclick="openAdModal(${ad.id})">
                            <img src="${ad.image}">
                            <span>${ad.name}</span>
                        </div>
                    `;
                });
            });
        }

        window.openAdModal = function(id) {
            const ad = ADS_CONFIG.find(a => a.id === id);
            if(!ad) return;
            document.getElementById('adModalTitle').innerText = ad.name;
            document.getElementById('adModalDesc').innerText = ad.desc;
            const img = document.getElementById('adModalImg');
            img.src = ad.image;
            img.style.display = 'inline-block';
            
            const linksDiv = document.getElementById('adModalLinks');
            linksDiv.innerHTML = '';
            if(ad.contact) {
                if(ad.contact.whatsapp) linksDiv.innerHTML += `<a href="${ad.contact.whatsapp}" target="_blank" class="btn btn-success"><i class="fa-brands fa-whatsapp"></i> Chat on WhatsApp</a>`;
                if(ad.contact.phone) linksDiv.innerHTML += `<a href="${ad.contact.phone}" class="btn btn-secondary"><i class="fa-solid fa-phone"></i> Call Now</a>`;
                if(ad.contact.website) linksDiv.innerHTML += `<a href="${ad.contact.website}" target="_blank" class="btn btn-primary"><i class="fa-solid fa-globe"></i> Visit Website</a>`;
            }

            new bootstrap.Modal(document.getElementById('adModal')).show();
        };

        // --- DATA LOGIC ---
        async function loadData() {
            try {
                const doc = await db.collection('league').doc('data').get();
                if (doc.exists) {
                    const loadedData = doc.data();
                    appData = { ...appData, ...loadedData };
                    
                    if(appData.players) {
                        appData.players.forEach(p => {
                            if(typeof p.groupId === 'undefined') p.groupId = null;
                        });
                    }
                } else {
                    await saveData();
                }
                
                applySettings();
                promptSessionTeam();
                refreshUI();
            } catch (e) { console.error(e); showToast("Load Error", "danger"); }
        }

        async function saveData() {
            try { await db.collection('league').doc('data').set(appData); } catch (e) { showToast("Save Error", "danger"); }
        }

        function refreshUI() {
            document.getElementById('heroTitle').innerText = `WISPLUS CHAMPIONS `;
            updateStandings();
            renderFixtures();
            renderPlayers();
            renderHistory();
            updateTicker();
            document.getElementById('pendingCountBadge').innerText = appData.resultsPending.filter(p=>p.status==='pending').length;
            document.getElementById('pendingCountBadge').style.display = appData.resultsPending.length ? 'inline-block' : 'none';
            document.querySelectorAll('.admin-mode').forEach(el => el.style.display = isAdmin ? 'inline-block' : 'none');
        }

        // --- GROUP & LEAGUE LOGIC ---
        function switchGroupView(dir) {
            if(dir === 'next') currentGroupView = currentGroupView === 'A' ? 'B' : 'A';
            else currentGroupView = currentGroupView === 'A' ? 'B' : 'A'; 
            updateStandings();
        }

        function updateStandings() {
            document.getElementById('groupTitleDisplay').innerText = `GROUP ${currentGroupView}`;
            
            // Calculate Stats
            appData.players.forEach(p => { p.mp=0; p.w=0; p.d=0; p.l=0; p.gf=0; p.ga=0; p.pts=0; });
            appData.results.forEach(r => {
                const fixture = appData.fixtures.find(f => f.id === r.fixtureId);
                if(fixture && fixture.stage === 'group') {
                    const p1 = appData.players.find(p => p.id === r.player1Id);
                    const p2 = appData.players.find(p => p.id === r.player2Id);
                    if(p1 && p2) {
                        p1.mp++; p2.mp++;
                        p1.gf+=r.score1; p1.ga+=r.score2;
                        p2.gf+=r.score2; p2.ga+=r.score1;
                        if(r.score1 > r.score2) { p1.w++; p1.pts+=3; p2.l++; }
                        else if(r.score1 < r.score2) { p2.w++; p2.pts+=3; p1.l++; }
                        else { p1.d++; p1.pts++; p2.d++; p2.pts++; }
                    }
                }
            });

            const tbody = document.getElementById('standingsTable');
            tbody.innerHTML = '';
            
            const groupPlayers = appData.players
                .filter(p => p.groupId === currentGroupView)
                .sort((a,b) => b.pts - a.pts || (b.gf-b.ga) - (a.gf-a.ga) || b.gf - a.gf);

            groupPlayers.forEach((p, i) => {
                const gd = p.gf - p.ga;
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${i+1}</td>
                        <td class="d-flex align-items-center"><img src="${p.avatar}" style="width:25px;height:25px;border-radius:50%;margin-right:5px;"> ${p.name}</td>
                        <td>${p.mp}</td><td>${p.w}</td><td>${p.d}</td><td>${p.l}</td>
                        <td>${p.gf}</td><td>${p.ga}</td><td>${gd>0?'+'+gd:gd}</td>
                        <td class="fw-bold text-dark">${p.pts}</td>
                    </tr>
                `;
            });

            if(groupPlayers.length === 0) tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No players assigned to Group ' + currentGroupView + ' yet. Use "Auto-Generate Groups".</td></tr>';
        }

        // --- FIXTURES LOGIC ---
        function changeMatchday(delta) {
            const uniqueStages = [...new Set(appData.fixtures.map(f => f.matchday || f.stage))];
            uniqueStages.sort((a,b) => {
                const isANum = !isNaN(a), isBNum = !isNaN(b);
                if(isANum && isBNum) return a - b;
                if(isANum) return -1;
                if(isBNum) return 1;
                const order = {'group':0, 'Round of 16':1, 'Quarter-Final':2, 'Semi-Final':3, 'Final':4};
                return (order[a]||99) - (order[b]||99);
            });
            
            let currIdx = uniqueStages.indexOf(currentMatchdayIndex);
            if(currIdx === -1 && uniqueStages.length > 0) currIdx = 0; 
            
            let newIdx = currIdx + delta;
            if(newIdx >= 0 && newIdx < uniqueStages.length) {
                currentMatchdayIndex = uniqueStages[newIdx];
                renderFixtures();
            }
        }

        function renderFixtures() {
            const container = document.getElementById('fixturesContainer');
            container.innerHTML = '';
            
            const displayVal = document.getElementById('currentMatchdayDisplay');
            
            let matches = [];
            if(typeof currentMatchdayIndex === 'number') {
                displayVal.innerText = `MATCHDAY ${currentMatchdayIndex}`;
                matches = appData.fixtures.filter(f => f.matchday === currentMatchdayIndex);
            } else {
                displayVal.innerText = currentMatchdayIndex; 
                matches = appData.fixtures.filter(f => f.stage === currentMatchdayIndex);
            }

            if(matches.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No matches scheduled.</p>';
                return;
            }

            if(matches[0].stage === 'group') {
                ['A', 'B'].forEach(gId => {
                    const gMatches = matches.filter(m => m.group === gId);
                    if(gMatches.length > 0) {
                        container.innerHTML += `<h6 class="text-primary border-bottom border-secondary pb-1 mt-3 mb-2">GROUP ${gId}</h6>`;
                        gMatches.forEach(m => container.innerHTML += createMatchCard(m));
                    }
                });
            } else {
                matches.forEach(m => container.innerHTML += createMatchCard(m));
            }
        }

        function createMatchCard(f) {
            const p1 = getPlayer(f.player1Id);
            const p2 = getPlayer(f.player2Id);
            const r = appData.results.find(x => x.fixtureId === f.id);
            const isKnockout = f.stage !== 'group';
            
            let centerContent = '';
            let actionButton = '';

            // 1. Check if there is a FINAL approved result
            if(r) {
                centerContent = `<div class="match-score text-dark">${r.score1} - ${r.score2}</div><div class="small text-muted fw-bold">FINAL</div>`;
            } 
            else {
                // 2. Check if there is a PENDING result
                const pending = appData.resultsPending.find(p => p.fixtureId === f.id && p.status === 'pending');
                
                if(pending) {
                    centerContent = `
                        <div class="match-score" style="color: #bbb;">${pending.score1} - ${pending.score2}</div>
                        <div class="badge bg-light text-muted border" style="font-size: 0.65rem;">Pending Admin...</div>
                    `;
                } else {
                    // 3. No result yet, show VS or Submit Button
                    centerContent = `<div class="fw-bold text-muted">VS</div>`;
                    
                    // Only show Submit Button if the current user matches one of the players
                    if(sessionTeamId === f.player1Id || sessionTeamId === f.player2Id) {
                        actionButton = `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success px-3 fw-bold" onclick="openPlayerSubmit('${f.id}')" style="font-size: 0.7rem; letter-spacing: 1px;">
                                    SUBMIT RESULT
                                </button>
                            </div>
                        `;
                    }
                }
            }

            // Admin manual override button
            let adminEdit = isAdmin ? `<button class="btn btn-xs text-primary" style="font-size:0.6rem" onclick="showResultModal('${f.id}')">[Admin Edit]</button>` : '';

            return `
                <div class="match-card ${isKnockout?'knockout':''}">
                    <div class="match-player justify-content-start">
                         <img src="${p1.avatar}"> <span>${p1.name}</span>
                    </div>
                    
                    <div class="match-center d-flex flex-column align-items-center">
                        ${centerContent}
                        ${actionButton}
                        ${adminEdit}
                    </div>
                    
                    <div class="match-player justify-content-end text-end">
                        <span>${p2.name}</span> <img src="${p2.avatar}">
                    </div>
                </div>
            `;
        }

        // --- GENERATION LOGIC ---
        async function generateSeason(type) {
            if(!isAdmin) return;
            bootstrap.Modal.getInstance(document.getElementById('generateLeagueModal')).hide();
            
            if(!confirm("Start new season? This clears current fixtures.")) return;
            
            appData.fixtures = [];
            appData.results = [];
            appData.resultsPending = [];
            appData.currentStage = 'group';

            const players = appData.players.map(p => p.id).sort(() => 0.5 - Math.random());
            if(players.length < 2) return showToast("Need more players", "warning");
            
            const mid = Math.ceil(players.length / 2);
            const groupA = players.slice(0, mid);
            const groupB = players.slice(mid);
            
            appData.players.forEach(p => {
                if(groupA.includes(p.id)) p.groupId = 'A';
                else if(groupB.includes(p.id)) p.groupId = 'B';
                else p.groupId = null;
            });

            const generateGroupFixtures = (pList, gName) => {
                if(pList.length % 2 !== 0) pList.push('BYE');
                const n = pList.length;
                const rounds = type === 'single' ? n-1 : (n-1)*2;
                
                for(let r=1; r<=rounds; r++) {
                    for(let i=0; i<n/2; i++) {
                        const h = pList[i];
                        const a = pList[n-1-i];
                        if(h !== 'BYE' && a !== 'BYE') {
                            appData.fixtures.push({
                                id: `${Date.now()}-${gName}-${r}-${i}`,
                                player1Id: r%2===1 ? a : h,
                                player2Id: r%2===1 ? h : a,
                                matchday: r,
                                group: gName,
                                stage: 'group',
                                date: new Date().toISOString()
                            });
                        }
                    }
                    pList.splice(1, 0, pList.pop()); 
                }
            };

            generateGroupFixtures([...groupA], 'A');
            generateGroupFixtures([...groupB], 'B');

            await saveData();
            refreshUI();
            showToast("Season Generated!", "success");
        }

        async function generateKnockouts() {
            if(!isAdmin) return;
            if(!confirm("End Group Stage and Generate Knockouts?")) return;

            const getTop2 = (gid) => {
                return appData.players.filter(p => p.groupId === gid)
                .map(p => {
                    let pts=0, gd=0, gf=0;
                    appData.results.forEach(r => {
                        const f = appData.fixtures.find(fx => fx.id === r.fixtureId);
                        if(f && f.stage==='group') {
                            const s1=r.score1, s2=r.score2;
                            if(f.player1Id===p.id) { gf+=s1; gd+=(s1-s2); pts+=(s1>s2?3:s1==s2?1:0); }
                            if(f.player2Id===p.id) { gf+=s2; gd+=(s2-s1); pts+=(s2>s1?3:s1==s2?1:0); }
                        }
                    });
                    return { ...p, pts, gd, gf };
                })
                .sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf)
                .slice(0, 2);
            };

            const topA = getTop2('A');
            const topB = getTop2('B');

            if(topA.length < 2 || topB.length < 2) return showToast("Not enough matches played", "warning");

            const sf1 = { id: `sf-${Date.now()}-1`, player1Id: topA[0].id, player2Id: topB[1].id, stage: 'Semi-Final', matchday: 'Semi-Final' };
            const sf2 = { id: `sf-${Date.now()}-2`, player1Id: topB[0].id, player2Id: topA[1].id, stage: 'Semi-Final', matchday: 'Semi-Final' };

            appData.fixtures = appData.fixtures.filter(f => f.stage === 'group'); 
            appData.fixtures.push(sf1, sf2);
            appData.currentStage = 'knockout';
            
            await saveData();
            currentMatchdayIndex = 'Semi-Final';
            refreshUI();
        }

        // --- PLAYER/ADMIN ACTIONS ---
        function loginAdmin() {
            if(document.getElementById('adminPassword').value === password) {
                isAdmin = true;
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
                refreshUI();
                showToast("Admin Logged In", "success");
            } else showToast("Wrong Password", "danger");
        }

        async function submitPlayer() {
            const name = document.getElementById('playerName').value;
            if(!name) return;
            appData.players.push({
                id: Date.now().toString(),
                name: name,
                avatar: document.getElementById('playerAvatarUrl').value || defaultAvatar,
                social: document.getElementById('playerSocialLink').value,
                phone: document.getElementById('playerPhone').value,
                groupId: null
            });
            await saveData();
            bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide();
            refreshUI();
        }

        function showResultModal(fid) {
            const f = appData.fixtures.find(x => x.id === fid);
            document.getElementById('resultMatchId').value = fid;
            document.getElementById('resultPlayer1Name').innerText = getPlayer(f.player1Id).name;
            document.getElementById('resultPlayer2Name').innerText = getPlayer(f.player2Id).name;
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        async function submitResult() {
            const fid = document.getElementById('resultMatchId').value;
            const s1 = parseInt(document.getElementById('resultScore1').value);
            const s2 = parseInt(document.getElementById('resultScore2').value);
            
            appData.results = appData.results.filter(r => r.fixtureId !== fid);
            appData.results.push({ fixtureId: fid, player1Id: appData.fixtures.find(f=>f.id===fid).player1Id, player2Id: appData.fixtures.find(f=>f.id===fid).player2Id, score1: s1, score2: s2, timestamp: Date.now() });
            
            const f = appData.fixtures.find(x => x.id === fid);
            if(f.stage === 'Semi-Final') checkForFinalGen();

            await saveData();
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
            refreshUI();
        }

        function checkForFinalGen() {
            const semis = appData.fixtures.filter(f => f.stage === 'Semi-Final');
            const semiResults = appData.results.filter(r => semis.some(s => s.id === r.fixtureId));
            
            if(semis.length === 2 && semiResults.length === 2) {
                const getWinner = (res) => res.score1 > res.score2 ? res.player1Id : res.player2Id;
                const w1 = getWinner(semiResults[0]);
                const w2 = getWinner(semiResults[1]);
                
                if(!appData.fixtures.find(f => f.stage === 'Final')) {
                    appData.fixtures.push({
                        id: `final-${Date.now()}`,
                        player1Id: w1, player2Id: w2,
                        stage: 'Final', matchday: 'Final'
                    });
                }
            }
        }

        // --- UTILS ---
        function getPlayer(id) { return appData.players.find(p => p.id === id) || { name: 'Unknown', avatar: defaultAvatar }; }
        function getContact(p) { 
            if(!p) return '';
            let html = '';
            if(p.social) html += `<a href="${p.social}" target="_blank" class="contact-btn btn-wa"><i class="fa-brands fa-whatsapp"></i></a>`;
            if(p.phone) html += `<a href="tel:${p.phone}" class="contact-btn btn-call"><i class="fa-solid fa-phone"></i></a>`;
            return html;
        }
        
        function showToast(msg, type) {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast show bg-${type} text-white`;
            el.innerHTML = `<div class="toast-body">${msg}</div>`;
            c.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        function promptSessionTeam() {
            const s = document.getElementById('sessionTeamSelect');
            appData.players.forEach(p => s.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            new bootstrap.Modal(document.getElementById('sessionTeamModal')).show();
        }
        function setSessionTeam() { 
            sessionTeamId = document.getElementById('sessionTeamSelect').value; 
            if(sessionTeamId) {
                showToast(`Welcome ${getPlayer(sessionTeamId).name}`, "success");
                bootstrap.Modal.getInstance(document.getElementById('sessionTeamModal')).hide();
                refreshUI();
            }
        }
        function skipSessionTeam() { bootstrap.Modal.getInstance(document.getElementById('sessionTeamModal')).hide(); }
        
        // --- ADMIN MODALS TRIGGERS ---
        function showAddPlayerModal() { new bootstrap.Modal(document.getElementById('addPlayerModal')).show(); }
        function openGenerateModal() { new bootstrap.Modal(document.getElementById('generateLeagueModal')).show(); }
        async function submitBackground() { 
            appData.backgroundUrl = `url('${document.getElementById('backgroundUrl').value}')`;
            await saveData(); applySettings(); bootstrap.Modal.getInstance(document.getElementById('editBackgroundModal')).hide(); 
        }
        function showEditBackgroundModal() { new bootstrap.Modal(document.getElementById('editBackgroundModal')).show(); }
        function applySettings() { document.documentElement.style.setProperty('--hero-bg-url', appData.backgroundUrl); }
        function showAddFixtureModal() {
            const s1 = document.getElementById('fixturePlayer1');
            const s2 = document.getElementById('fixturePlayer2');
            s1.innerHTML = ''; s2.innerHTML = '';
            appData.players.forEach(p => {
                const opt = `<option value="${p.id}">${p.name}</option>`;
                s1.innerHTML+=opt; s2.innerHTML+=opt;
            });
            new bootstrap.Modal(document.getElementById('addFixtureModal')).show();
        }
        async function submitFixture() {
            appData.fixtures.push({
                id: Date.now().toString(),
                player1Id: document.getElementById('fixturePlayer1').value,
                player2Id: document.getElementById('fixturePlayer2').value,
                date: document.getElementById('fixtureDate').value,
                matchday: isNaN(parseInt(document.getElementById('fixtureMatchday').value)) ? document.getElementById('fixtureMatchday').value : parseInt(document.getElementById('fixtureMatchday').value),
                stage: document.getElementById('fixtureStage').value
            });
            await saveData();
            bootstrap.Modal.getInstance(document.getElementById('addFixtureModal')).hide();
            refreshUI();
        }
        
        // --- RENDERING OTHERS ---
        function renderPlayers() {
            const c = document.getElementById('playersContainer');
            c.innerHTML = '';
            appData.players.forEach(p => {
                c.innerHTML += `
                    <div class="col">
                        <div class="card p-3 text-center h-100 position-relative">
                            <img src="${p.avatar}" style="width:70px;height:70px;border-radius:50%;margin:0 auto;" class="mb-2 border border-2 border-primary">
                            <h6 class="text-truncate">${p.name}</h6>
                            <div class="badge bg-secondary mb-2">${p.groupId ? 'Group '+p.groupId : 'No Group'}</div>
                            <div class="d-flex justify-content-center">${getContact(p)}</div>
                            ${isAdmin ? `<button class="btn btn-sm btn-light position-absolute top-0 end-0 m-2" onclick="openEditPlayerModal('${p.id}')"><i class="fa-solid fa-pen"></i></button>` : ''}
                        </div>
                    </div>`;
            });
        }

        // --- NEW EDIT PLAYER FUNCTIONS ---
        function openEditPlayerModal(pid) {
            const p = getPlayer(pid);
            if(!p) return;
            document.getElementById('editPlayerId').value = pid;
            document.getElementById('editPlayerName').value = p.name;
            document.getElementById('editPlayerAvatarUrl').value = p.avatar === defaultAvatar ? '' : p.avatar;
            document.getElementById('editPlayerSocialLink').value = p.social || '';
            document.getElementById('editPlayerPhone').value = p.phone || '';
            new bootstrap.Modal(document.getElementById('editPlayerModal')).show();
        }

        async function submitEditPlayer() {
            const pid = document.getElementById('editPlayerId').value;
            const pIndex = appData.players.findIndex(x => x.id === pid);
            if(pIndex === -1) return;

            appData.players[pIndex].name = document.getElementById('editPlayerName').value;
            appData.players[pIndex].avatar = document.getElementById('editPlayerAvatarUrl').value || defaultAvatar;
            appData.players[pIndex].social = document.getElementById('editPlayerSocialLink').value;
            appData.players[pIndex].phone = document.getElementById('editPlayerPhone').value;

            await saveData();
            bootstrap.Modal.getInstance(document.getElementById('editPlayerModal')).hide();
            refreshUI();
            showToast("Player updated successfully", "success");
        }
        
        function renderHistory() {
            const t = document.getElementById('trophyContainer');
            if(appData.history.length === 0) t.innerHTML = '<p class="text-center text-muted">No history yet.</p>';
        }
        
        function updateTicker() {
            const t = document.getElementById('tickerContent');
            if(appData.results.length === 0) {
                t.innerText = `WELCOME TO SEASON ${appData.season} | TOURNAMENT MODE ONLINE`;
            } else {
                const res = appData.results.sort((a,b)=>b.timestamp-a.timestamp)[0];
                const p1 = getPlayer(res.player1Id).name;
                const p2 = getPlayer(res.player2Id).name;
                t.innerText = `LATEST: ${p1} ${res.score1} - ${res.score2} ${p2} | SEASON ${appData.season}`;
            }
        }

        async function endSeasonManual() {
            if(!isAdmin || !confirm("Archive Season?")) return;
            appData.season++;
            appData.fixtures = [];
            appData.results = [];
            appData.resultsPending = [];
            appData.players.forEach(p => p.groupId = null);
            await saveData();
            refreshUI();
        }

        // --- SUBMIT RESULT LOGIC ---
        function openPlayerSubmit(fid) {
             const f = appData.fixtures.find(x => x.id === fid);
             document.getElementById('ps_fixtureId').value = fid;
             const hS = document.getElementById('ps_homeSelect');
             const aS = document.getElementById('ps_awaySelect');
             const p1 = getPlayer(f.player1Id);
             const p2 = getPlayer(f.player2Id);
             
             hS.innerHTML = `<option value="${p1.id}">${p1.name}</option><option value="${p2.id}">${p2.name}</option>`;
             aS.innerHTML = `<option value="${p2.id}">${p2.name}</option><option value="${p1.id}">${p1.name}</option>`;
             
             new bootstrap.Modal(document.getElementById('playerSubmitModal')).show();
        }

        async function submitPlayerResult() {
            const fid = document.getElementById('ps_fixtureId').value;
            const s1 = parseInt(document.getElementById('ps_score1').value);
            const s2 = parseInt(document.getElementById('ps_score2').value);
            
            appData.resultsPending.push({
                id: 'p'+Date.now(), fixtureId: fid, 
                score1: s1, score2: s2, 
                status: 'pending', timestamp: Date.now()
            });
            await saveData();
            bootstrap.Modal.getInstance(document.getElementById('playerSubmitModal')).hide();
            showToast("Result Pending Approval", "info");
            refreshUI();
        }

        function showPendingModal() {
            const list = document.getElementById('pendingListContent');
            list.innerHTML = '';
            appData.resultsPending.filter(p=>p.status==='pending').forEach(p => {
                const f = appData.fixtures.find(x => x.id === p.fixtureId);
                const p1 = getPlayer(f.player1Id).name;
                const p2 = getPlayer(f.player2Id).name;
                list.innerHTML += `
                    <div class="card p-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <div><strong>${p1} vs ${p2}</strong><br>${p.score1} - ${p.score2}</div>
                            <button class="btn btn-sm btn-success" onclick="approvePending('${p.id}')">Approve</button>
                        </div>
                    </div>`;
            });
            new bootstrap.Modal(document.getElementById('pendingModal')).show();
        }

        async function approveAllPending() {
            const pending = appData.resultsPending.filter(p=>p.status==='pending');
            for(let p of pending) { await approvePending(p.id, false); }
            refreshUI();
        }

        async function approvePending(pid, refresh=true) {
            const p = appData.resultsPending.find(x => x.id === pid);
            if(!p) return;
            p.status = 'approved';
            appData.results.push({
                fixtureId: p.fixtureId,
                score1: p.score1, score2: p.score2,
                player1Id: appData.fixtures.find(f=>f.id===p.fixtureId).player1Id,
                player2Id: appData.fixtures.find(f=>f.id===p.fixtureId).player2Id,
                timestamp: Date.now()
            });
            await saveData();
            if(refresh) {
                bootstrap.Modal.getInstance(document.getElementById('pendingModal')).hide();
                refreshUI();
            }
        }
    </script>
</body>
</html>