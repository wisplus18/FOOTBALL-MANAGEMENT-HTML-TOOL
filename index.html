<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Football Mobile League</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #00c6ff;
            --gold-accent: #ffd700;
            --stadium-green: #28a745;
            --danger-red: #dc3545;
            --grey: #6c757d;

            /* --- Theme Variables (DEFAULT: DARK) --- */
            --bg-main: #121212;
            --bg-light: #1e1e1e;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #444;
            --hero-bg-url: url('stadium.jpg'); /* Default background */
        }

        body[data-theme="light"] {
            --bg-main: #f0f2f5;
            --bg-light: #ffffff;
            --bg-lighter: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- NEW: Intro Overlay Styles (Image + Text) --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-main);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
            opacity: 1;
            transition: opacity 5s ease-out;
        }

        /* 1. Scrolling Text Marquee */
        #intro-text-marquee {
            position: absolute;
            top: 50%;
            white-space: nowrap;
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            padding: 0 100vw; 
            display: none; 
            animation: marquee 0.01s linear forwards; 
        }
        @keyframes marquee {
            0% { transform: translate(100%, -50%); } 
            100% { transform: translate(-100%, -50%); } 
        }

        /* 2. Intro Image Container */
        #intro-image-container {
            display: none; 
            width: 100%;
            height: 100%;
            background-color: var(--bg-main);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }
        #intro-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed from cover to contain for better image display */
            opacity: 0.9; 
        }
        /* --- End Intro Overlay --- */
        
        /* --- Navbar --- */
        .navbar {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color) !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand img, .navbar-brand svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            font-weight: 500;
            padding: 10px 15px;
            transition: color 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: var(--primary-color);
        }
        
        #theme-toggle {
            font-size: 1.1rem;
            line-height: 1;
        }
        /* --- Live Ticker --- */
        .live-ticker {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
        }
        .live-ticker-content {
            display: inline-block;
            animation: tickerSlide 35s linear infinite;
        }

        @keyframes tickerSlide {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* --- Hero Section --- */
        .hero {
            /* Now uses the CSS variable which will be set by JS */
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)), var(--hero-bg-url);
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 100px 20px 80px 20px;
            border-bottom: 2px solid var(--primary-color);
            min-height: 400px; /* FIX: Ensure minimum height to prevent 'broken pixels' on load */
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 650px;
            margin: 20px auto 30px auto;
            font-weight: 300;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 12px 30px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
        }
        .btn-secondary {
            background-color: var(--grey);
            border-color: var(--grey);
        }

        /* --- Section Styling --- */
        section {
            padding: 60px 0;
            transition: background-color 0.3s ease;
        }
        section:nth-of-type(odd) {
            background-color: var(--bg-light);
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 40px;
            text-align: center;
            text-transform: uppercase;
        }
        
        /* --- Card Styling --- */
        .card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .card-body {
            padding: 1.5rem;
        }
        .card-header {
            background-color: var(--bg-lighter);
            border-bottom: 1px solid var(--border-color);
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* --- Standings Table --- */
        .league-table {
            background-color: var(--bg-light);
            border-color: var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .league-table thead th {
            background-color: var(--bg-lighter);
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease;
        }
        
        .league-table tbody tr:hover {
            background-color: var(--bg-lighter);
        }
        
        .league-table th, .league-table td {
            vertical-align: middle;
            padding: 0.9rem 0.75rem;
            border-bottom-color: var(--border-color);
        }
        
        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .player-name-cell img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        
        .player-profile-link {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.3s;
        }
        .player-profile-link:hover {
            color: var(--primary-color);
        }

        .pos-cell { font-weight: 700; font-size: 1.1rem; width: 40px; text-align: center; }
        .pts-cell { font-weight: 700; font-size: 1.1rem; }

        .form-cell .form-bubble {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
            margin: 0 1px;
        }
        .form-bubble-W { background-color: var(--stadium-green); }
        .form-bubble-D { background-color: var(--grey); }
        .form-bubble-L { background-color: var(--danger-red); }

        .top-team-row { border-left: 4px solid var(--gold-accent); }
        .mid-team-row { border-left: 4px solid var(--primary-color); }
        .bottom-team-row { border-left: 4px solid var(--danger-red); }

        /* --- Fixtures / Results Card --- */
        .matchday-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .matchday-nav h4 { color: var(--text-primary); font-weight: 500; margin: 0; width: 150px; text-align: center; }
        
        .match-card, .result-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .match-card:hover, .result-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .match-player, .result-player {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 40%;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .match-player img, .result-player img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-main);
        }
        .match-player:last-of-type, .result-player:last-of-type {
            justify-content: flex-end;
            text-align: right;
        }
        
        .match-info, .result-info { text-align: center; width: 20%; }
        .match-info .vs { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .match-info .date { font-size: 0.85rem; color: var(--text-secondary); }
        
        .result-info .score { font-size: 2rem; font-weight: 900; color: var(--text-primary); letter-spacing: 2px; }
        .result-info .score .winner { color: var(--gold-accent); }

        .admin-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .match-card, .result-card { position: relative; }

        /* --- Players Section --- */
        .player-card {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.15);
        }
        .player-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem auto;
            border: 3px solid var(--primary-color);
            background-color: var(--bg-main);
        }
        .player-card .card-title { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }
        .player-card .card-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; }

        /* --- Prizes Section --- */
        .prize-card {
            background: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .prize-card:hover { transform: scale(1.03); }
        .prize-card .prize-icon { font-size: 3rem; margin-bottom: 1rem; }
        .prize-card-1 .prize-icon { color: var(--gold-accent); }
        .prize-card-2 .prize-icon { color: #c0c0c0; }
        .prize-card-3 .prize-icon { color: #cd7f32; }
        .prize-card h3 { font-size: 1.3rem; font-weight: 500; color: var(--text-secondary); }
        .prize-card p { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .prize-total { text-align: center; font-size: 1.5rem; margin-bottom: 2rem; }
        .prize-total strong { color: var(--primary-color); font-size: 2rem; font-weight: 700; }
        
        /* --- Admin / Modals --- */
        .admin-mode { display: none; }
        
        .modal-content {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-header, .modal-footer {
            border-bottom-color: var(--border-color);
            border-top-color: var(--border-color);
            transition: border-color 0.3s ease;
        }
        .btn-close {
            /* Fix for light theme */
            filter: var(--text-primary) == '#ffffff' ? invert(1) : none;
        }
        body[data-theme="light"] .btn-close {
             filter: none;
        }

        .form-control, .form-select {
            background-color: var(--bg-main);
            border-color: var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-main);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-control:disabled { background-color: var(--bg-lighter); }
        
        .result-modal-scores { display: flex; justify-content: center; align-items: center; gap: 1rem; }
        .result-modal-scores label { font-size: 1.1rem; font-weight: 500; }
        .result-modal-scores input { width: 80px; font-size: 2rem; font-weight: 700; text-align: center; }
        .result-modal-vs { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        
        /* Toast Styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1rem; }
            .navbar-brand { font-size: 1.2rem; }
            .nav-link { font-size: 0.9rem; padding: 8px 12px; }
            
            #intro-text-marquee { font-size: 1.5rem; }

            .match-card, .result-card { flex-direction: column; gap: 1rem; padding: 1rem; }
            .match-player, .result-player { width: 100%; font-size: 1rem; }
            .match-player:last-of-type, .result-player:last-of-type { justify-content: flex-start; text-align: left; }
            .match-info, .result-info { width: 100%; display: flex; justify-content: space-between; align-items: center; }
            .result-info .score { font-size: 1.8rem; }
            .match-info .vs { order: 2; }
            .match-info .date { order: 1; }
            
            .table-responsive { border-radius: 10px; }
            .table { font-size: 0.85rem; }
            .player-name-cell img { width: 30px; height: 30px; }
            
            /* Hide columns on mobile to save space */
            .table th:nth-child(7), .table td:nth-child(7), /* GF */
            .table th:nth-child(8), .table td:nth-child(8), /* GA */
            .table th:nth-child(10), .table td:nth-child(10) /* Form */
            {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="intro-overlay">
        <div id="intro-text-marquee">WELCOME TO THE EFOOTBALL LEAGUE</div>
        <div id="intro-image-container">
            <img id="intro-image" src="" alt="League Intro Image">
        </div>
    </div>
    <div class="toast-container" id="toast-container"></div>


    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="#007bff">
                    <path d="M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM76.4,26.66l-6.85,6.85a28,28,0,0,1-13.7,11.37L50,50,44.15,44.88a28,28,0,0,1-11.37-13.7L25.93,23.6A38.56,38.56,0,0,1,50,11.5a38.16,38.16,0,0,1,26.4,15.16ZM23.6,74.07l6.85-6.85a28,28,0,0,1,13.7-11.37L50,50,55.85,55.12a28,28,0,0,1,11.37,13.7l6.85,6.85A38.56,38.56,0,0,1,50,88.5,38.16,38.16,0,0,1,23.6,74.07Z"/>
                </svg>
                E-FOOTBALL LEAGUE
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#standings">Standings</a></li>
                    <li class="nav-item"><a class="nav-link" href="#fixtures">Fixtures</a></li>
                    <li class="nav-item"><a class="nav-link" href="#results">Results</a></li>
                    <li class="nav-item"><a class="nav-link" href="#players">Players</a></li>
                    <li class="nav-item"><a class="nav-link" href="#prizes">Prizes</a></li>
                    <li class="nav-item">
                        <button class="btn nav-link" id="theme-toggle" aria-label="Toggle theme">
                            <i class="fa-solid fa-sun"></i> </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary ms-2" id="admin-login-button">
                            <i class="fa-solid fa-lock me-1"></i> Admin
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="live-ticker" id="liveTicker">
        <span class="live-ticker-content"></span>
    </div>

    <section class="hero">
        <div class="container">
            <h1>HALOTEL LEAGUE</h1>
            <p>Join the exciting Halotel league! Win data prizes from a pool of 12 GB. Check the standings, fixtures, and results here.</p>
            <a href="#standings" class="btn btn-primary">View Standings</a>
        </div>
    </section>

    <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter Password" aria-label="Admin Password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="loginAdmin()">Login</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editBackgroundModal" tabindex="-1" aria-labelledby="editBackgroundModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBackgroundModalLabel">Edit Hero Background</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="backgroundFile" class="form-label">Upload Image from Gallery (Requires Firebase Storage)</label>
                        <input type="file" id="backgroundFile" class="form-control" accept="image/png, image/jpeg, image/webp" disabled>
                        <small class="text-danger">NOTE: Local file upload is disabled. Use the URL field below.</small>
                    </div>
                    <div class="text-center text-secondary my-2">OR (URL takes precedence)</div>
                    <div class="mb-3">
                        <label for="backgroundUrl" class="form-label">Background Image URL</label>
                        <input type="url" id="backgroundUrl" class="form-control" placeholder="Paste image URL (e.g., https://example.com/stadium.jpg)" aria-label="Background URL">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="resetBackground()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" onclick="submitBackground()">Set Background</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editIntroImageModal" tabindex="-1" aria-labelledby="editIntroImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editIntroImageModalLabel">Edit Intro Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="introImageFile" class="form-label">Upload Image from Gallery (Requires Firebase Storage)</label>
                        <input type="file" id="introImageFile" class="form-control" accept="image/png, image/jpeg, image/webp" disabled>
                        <small class="text-danger">NOTE: Local file upload is disabled. Use the URL field below.</small>
                    </div>
                    <div class="text-center text-secondary my-2">OR (URL takes precedence)</div>
                    <div class="mb-3">
                        <label for="introImageUrl" class="form-label">Intro Image URL</label>
                        <input type="url" id="introImageUrlInput" class="form-control" placeholder="Paste image URL (e.g., https://example.com/league_logo.png)" aria-label="Intro Image URL">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="resetIntroImage()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" onclick="submitIntroImage()">Set Intro Image</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlayerModalLabel">Add Player</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">Player Name</label>
                        <input type="text" id="playerName" class="form-control" placeholder="Enter name" aria-label="Player Name">
                    </div>
                    <div class="mb-3">
                        <label for="playerAvatarFile" class="form-label">Upload Avatar (Requires Firebase Storage)</label>
                        <input type="file" id="playerAvatarFile" class="form-control" accept="image/png, image/jpeg, image/webp" disabled>
                        <small class="text-danger">NOTE: Local file upload is disabled. Use the URL field below.</small>
                    </div>
                    <div class="text-center text-secondary my-2">OR</div>
                    <div class="mb-3">
                        <label for="playerAvatarUrl" class="form-label">Avatar URL</label>
                        <input type="url" id="playerAvatarUrl" class="form-control" placeholder="Paste image URL" aria-label="Player Avatar URL">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitPlayer()">Add Player</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addFixtureModal" tabindex="-1" aria-labelledby="addFixtureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFixtureModalLabel">Add Fixture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fixturePlayer1" class="form-label">Player 1</label>
                        <select id="fixturePlayer1" class="form-select" aria-label="Player 1"></select>
                    </div>
                    <div class="mb-3">
                        <label for="fixturePlayer2" class="form-label">Player 2</label>
                        <select id="fixturePlayer2" class="form-select" aria-label="Player 2"></select>
                    </div>
                    <div class="mb-3">
                        <label for="fixtureDate" class="form-label">Date</label>
                        <input type="date" id="fixtureDate" class="form-control" aria-label="Fixture Date">
                    </div>
                    <div class="mb-3">
                        <label for="fixtureMatchday" class="form-label">Matchday</label>
                        <input type="number" id="fixtureMatchday" class="form-control" min="1" value="1" aria-label="Matchday">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitFixture()">Add Fixture</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Enter Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resultFixtureId">
                    <div class="text-center mb-3">
                        <h6 id="resultModalPlayer1Name">Player 1</h6>
                    </div>
                    <div class="result-modal-scores">
                        <input type="number" id="resultScore1" class="form-control" min="0" aria-label="Player 1 Score">
                        <span class="result-modal-vs">-</span>
                        <input type="number" id="resultScore2" class="form-control" min="0" aria-label="Player 2 Score">
                    </div>
                     <div class="text-center mt-3">
                        <h6 id="resultModalPlayer2Name">Player 2</h6>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitResult()">Update Result</button>
                </div>
            </div>
        </div>
    </div>
    
    <section id="standings" class="py-5">
        <div class="container">
            <h2 class="section-title">Standings</h2>
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table league-table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" class="pos-cell">#</th>
                                    <th scope="col" style="width: 30%;">Player</th>
                                    <th scope="col">MP</th>
                                    <th scope="col">W</th>
                                    <th scope="col">D</th>
                                    <th scope="col">L</th>
                                    <th scope="col">GF</th>
                                    <th scope="col">GA</th>
                                    <th scope="col">GD</th>
                                    <th scope="col" class="form-cell">Form</th>
                                    <th scope="col" class="pts-cell">Pts</th>
                                </tr>
                            </thead>
                            <tbody id="standingsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="admin-mode mt-4 text-center">
                <button class="btn btn-primary me-2" onclick="showAddPlayerModal()">
                    <i class="fa-solid fa-user-plus me-1"></i> Add Player
                </button>
                <button class="btn btn-info me-2 text-white" onclick="showEditBackgroundModal()">
                    <i class="fa-solid fa-image me-1"></i> Edit Background
                </button>
                <button class="btn btn-success me-2 text-white" onclick="showEditIntroImageModal()">
                    <i class="fa-solid fa-camera me-1"></i> Edit Intro Image
                </button>
                <button class="btn btn-danger" onclick="resetLeague()">
                    <i class="fa-solid fa-trash me-1"></i> Reset League
                </button>
            </div>
        </div>
    </section>

    <section id="fixtures" class="py-5">
        <div class="container">
            <h2 class="section-title">Fixtures</h2>
            <div class="matchday-nav">
                <button class="btn btn-primary" id="prevMatchday" onclick="changeMatchday(-1)">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h4 id="currentMatchday">Matchday 1</h4>
                <button class="btn btn-primary" id="nextMatchday" onclick="changeMatchday(1)">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            <div id="fixturesContainer">
                </div>
            <div class="admin-mode mt-4 text-center">
                <button class="btn btn-primary me-2" onclick="showAddFixtureModal()">
                    <i class="fa-solid fa-calendar-plus me-1"></i> Add Fixture
                </button>
                <button class="btn btn-success" onclick="generateFixtures()">
                    <i class="fa-solid fa-cogs me-1"></i> Generate Fixtures
                </button>
            </div>
        </div>
    </section>

    <section id="results" class="py-5">
        <div class="container">
            <h2 class="section-title">Results</h2>
            <div class="row justify-content-center mb-4">
                <div class="col-md-6">
                    <label for="teamSelector" class="form-label">Filter by Player</LabeL>
                    <select id="teamSelector" class="form-select" onchange="filterTeamResults()" aria-label="Select Player">
                        <option value="">Show All</option>
                    </select>
                </div>
            </div>
            <div id="resultsContainer">
            </div>
        </div>
    </section>

    <section id="players" class="py-5">
        <div class="container">
            <h2 class="section-title">Players</h2>
            <div class="row" id="playersContainer">
            </div>
        </div>
    </section>

    <section id="prizes" class="py-5">
        <div class="container">
            <h2 class="section-title">League Prizes</h2>
            <p class="prize-total">Total prize pool: <strong>12 GB</strong> of Halotel data!</p>
            <div class="row g-4">
                <div class="col-md-4"><div class="prize-card prize-card-1"><div class="prize-icon"><i class="fa-solid fa-trophy"></i></div><h3>1st Place</h3><p>1.7 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card prize-card-2"><div class="prize-icon"><i class="fa-solid fa-medal"></i></div><h3>2nd Place</h3><p>1.5 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card prize-card-3"><div class="prize-icon"><i class="fa-solid fa-award"></i></div><h3>3rd Place</h3><p>1.3 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>4th Place</h3><p>1.0 GB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>5th Place</h3><p>900 MB</p></div></div>
                <div class="col-md-4"><div class="prize-card"><h3>6th Place</h3><p>600 MB</p></div></div>
            </div>
            <p class="text-center text-secondary mt-4">
                <em>Data prizes will be applied to your Halotel number. Validity may vary.</em>
            </p>
        </div>
    </section>

    <section id="import-export" class="py-5">
        <div class="container">
            <h2 class="section-title">Import/Export Data (Admin)</h2>
            <div class="card">
                <div class="card-body">
                    <textarea id="dataJson" class="form-control" rows="5" placeholder="Paste JSON here to import" aria-label="JSON Data"></textarea>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary me-2" onclick="importData()">Import Data</button>
                        <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        // ================================================================
        // FIREBASE CONFIGURATION (REPLACE WITH YOUR OWN)
        // ================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCLycBxpQ3MMIDLYjmBqMZv32FIu2eDXF4", // <--- REPLACE
            authDomain: "efootball-app-ce90b.firebaseapp.com", // <--- REPLACE
            projectId: "efootball-app-ce90b", // <--- REPLACE
            storageBucket: "efootball-app-ce90b.firebasestorage.app", // <--- REPLACE (Only needed if you re-enable file uploads)
            messagingSenderId: "387933114333", // <--- REPLACE
            appId: "1:387933114333:web:1c85dbadacf70d0406b034" // <--- REPLACE
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const password = "Genie"; // Your admin password
        let leagueData = {
            players: [],
            fixtures: [],
            results: [],
            backgroundUrl: 'url("stadium.jpg")',
            introImageUrl: 'https://i.imgur.com/8Qj9Y0b.png' // NEW: Default placeholder image
        };
        let currentMatchday = 1;
        let totalMatchdays = 1;
        let isAdmin = false;

        // Default SVG avatar
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%236c757d'%3E%3Cpath d='M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM50,15A35,35,0,1,1,15,50,35,35,0,0,1,50,15ZM50,25A10,10,0,1,1,40,35,10,10,0,0,1,50,25ZM50,80a27,27,0,0,1-25-12.87c.2-8.3,16.72-12.93,25-12.93s24.8,4.63,25,12.93A27,27,0,0,1,50,80Z'/%3E%3C/svg%3E";

        // --- Theme Toggle Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        function applyTheme(theme) { 
            if (theme === 'light') { 
                document.body.dataset.theme = 'light'; 
                themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>'; 
                localStorage.setItem('theme', 'light'); 
            } else { 
                delete document.body.dataset.theme; 
                themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; 
                localStorage.setItem('theme', 'dark'); 
            } 
        } 
        function toggleTheme() { 
            const currentTheme = localStorage.getItem('theme') || 'light'; 
            applyTheme(currentTheme === 'light' ? 'dark' : 'light'); 
        } 
        // --- End Theme Logic ---

        // Apply Background Style
        function applyBackground() {
            document.documentElement.style.setProperty('--hero-bg-url', leagueData.backgroundUrl || 'url("stadium.jpg")');
        }

        // Load data from Firebase
        async function loadData() {
            try {
                const leagueSnapshot = await db.collection('league').doc('data').get();
                if (leagueSnapshot.exists) {
                    leagueData = leagueSnapshot.data();
                    if (!leagueData.players) leagueData.players = [];
                    if (!leagueData.fixtures) leagueData.fixtures = [];
                    if (!leagueData.results) leagueData.results = [];
                    if (!leagueData.backgroundUrl) leagueData.backgroundUrl = 'url("stadium.jpg")'; // Set default if missing
                    if (!leagueData.introImageUrl) leagueData.introImageUrl = 'https://i.imgur.com/8Qj9Y0b.png'; // NEW: Set default if missing
                } else {
                    await saveData(false); // Don't show toast on first-time save
                }
                applyBackground(); // Apply loaded background
                updateViews();
                populateTeamSelector();
                populateFixtureSelectors();
                calculateTotalMatchdays();
                updateLiveTicker();
                
                // START INTRO SEQUENCE HERE
                startIntroSequence();

            } catch (error) {
                console.error("Error loading data: ", error);
                // If data fails to load, ensure the page still proceeds
                updateViews();
                startIntroSequence();
                showToast('Error loading data! Check Firebase config.', 'danger');
            }
        }

        // Save data to Firebase
        async function saveData(showSuccessToast = true) {
            try {
                // Ensure introImageUrl is saved
                const dataToSave = { ...leagueData }; 
                await db.collection('league').doc('data').set(dataToSave);
                updateViews();
                if(isAdmin && showSuccessToast) {
                    showToast('Data saved successfully! 💾', 'success');
                }
            } catch (error) {
                console.error("Error saving data: ", error);
                showToast('Error saving data! Check Firebase rules.', 'danger');
            }
        }
        
        // Generic Toast Notification
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const toastContainer = document.getElementById('toast-container');

            const wrapper = document.createElement('div');
            wrapper.innerHTML = toastHtml;
            const toastEl = wrapper.firstChild;
            toastContainer.appendChild(toastEl);

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }


        // --- NEW INTRO LOGIC ---
        function startIntroSequence() {
            const overlay = document.getElementById('intro-overlay');
            const textMarquee = document.getElementById('intro-text-marquee');
            const imageContainer = document.getElementById('intro-image-container');
            const introImage = document.getElementById('intro-image');

            // Set the image source
            introImage.src = leagueData.introImageUrl || 'https://i.imgur.com/8Qj9Y0b.png';

            // Helper function to dismiss the intro
            const dismissIntro = () => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    document.body.style.overflowY = 'auto'; // Re-enable scrolling
                }, 500); // Wait for fade-out transition (0.5s)
            };

            // Disable scrolling during intro
            document.body.style.overflowY = 'hidden'; 
            
            // 1. Start Text Marquee
            textMarquee.style.display = 'block';
            textMarquee.style.animation = 'marquee 3s linear forwards'; 
            
            // Time for text to scroll (1 second)
            setTimeout(() => {
                textMarquee.style.animation = 'none';
                textMarquee.style.display = 'none';

                // 2. Hide Text, Show Image (Fade In)
                imageContainer.style.display = 'flex';
                
                setTimeout(() => {
                    imageContainer.style.opacity = '1'; 
                }, 50);

                // 3. Keep Image for 3 seconds, then dismiss
                const imageDisplayTime = 3000; // 3 seconds
                setTimeout(dismissIntro, imageDisplayTime);

            }, 1000); // Wait 1 second for the text scroll
        }

        // --- NEW ADMIN FUNCTIONS FOR INTRO IMAGE ---
        function showEditIntroImageModal() {
            if (!isAdmin) { showToast('You must be an admin to change the intro image.', 'danger'); return; }
            const introUrlInput = document.getElementById('introImageUrlInput');
            // Check if the current URL is the default placeholder before showing in the input
            introUrlInput.value = (leagueData.introImageUrl && leagueData.introImageUrl !== 'https://i.imgur.com/8Qj9Y0b.png') ? leagueData.introImageUrl : '';
            const modal = new bootstrap.Modal(document.getElementById('editIntroImageModal'));
            modal.show();
        }

        async function submitIntroImage() {
            const urlInput = document.getElementById('introImageUrlInput').value.trim();
            const fileInput = document.getElementById('introImageFile');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editIntroImageModal'));
            
            if (urlInput) {
                leagueData.introImageUrl = urlInput;
                await saveData();
                modal.hide();
                showToast('Intro Image URL updated! It will display on next page load. ✨', 'success');
            } else if (fileInput.files.length > 0) {
                 showToast('File upload is not enabled. Please use the **URL** option for the intro image.', 'danger');
            } else {
                showToast('No URL provided. Keeping current image.', 'info');
            }
        }

        async function resetIntroImage() {
            leagueData.introImageUrl = 'https://i.imgur.com/8Qj9Y0b.png';
            await saveData();
            document.getElementById('introImageUrlInput').value = '';
            document.getElementById('introImageFile').value = '';
            bootstrap.Modal.getInstance(document.getElementById('editIntroImageModal')).hide();
            showToast('Intro Image reset to default! 🖼️', 'warning');
        }
        // --- END NEW ADMIN FUNCTIONS ---


        // Update all views
        function updateViews() {
            updateStandings();
            updateFixtures();
            updateResults();
            updatePlayers();
        }

        // Calculate total matchdays
        function calculateTotalMatchdays() {
            const matchdays = leagueData.fixtures.map(f => f.matchday);
            totalMatchdays = matchdays.length > 0 ? Math.max(...matchdays) : 1;
            if (currentMatchday > totalMatchdays) {
                currentMatchday = totalMatchdays;
            }
        }

        // Update Live Ticker
        function updateLiveTicker() {
            const tickerContent = document.querySelector('#liveTicker .live-ticker-content');
            
            // Sort results by timestamp (or ID/a unique marker) to get the most recent
            const latestResult = leagueData.results.sort((a, b) => b.timestamp - a.timestamp)[0];
            
            let tickerText = "Welcome to the eFootball Mobile League! Check here for live score updates...";

            if (latestResult) {
                const p1 = leagueData.players.find(p => p.id === latestResult.player1Id) || { name: 'Player 1' };
                const p2 = leagueData.players.find(p => p.id === latestResult.player2Id) || { name: 'Player 2' };
                const winnerName = latestResult.score1 > latestResult.score2 ? p1.name : (latestResult.score2 > latestResult.score1 ? p2.name : 'Draw');

                tickerText = `🏆 LATEST RESULT: ${p1.name} ${latestResult.score1} - ${latestResult.score2} ${p2.name}. Winner: ${winnerName}! | Next matchday is ${currentMatchday}. | `;
            }

            // Repeat the text to ensure the animation is smooth
            tickerContent.innerText = tickerText.repeat(5);
        }
        
        // --- Admin/Login Logic ---
        function showAdminLogin() {
            const modal = new bootstrap.Modal(document.getElementById('adminModal'));
            modal.show();
        }

        function loginAdmin() {
            const input = document.getElementById('adminPassword');
            if (input.value === password) {
                isAdmin = true;
                document.getElementById('admin-login-button').innerHTML = '<i class="fa-solid fa-unlock me-1"></i> Admin Logged In';
                document.getElementById('admin-login-button').classList.remove('btn-outline-primary');
                document.getElementById('admin-login-button').classList.add('btn-success');
                document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'block');
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
                showToast('Admin mode activated! 🔑', 'success');
            } else {
                showToast('Incorrect password.', 'danger');
            }
            input.value = '';
        }

        // --- Background Admin Logic (Updated for URL/File) ---
        function showEditBackgroundModal() {
            if (!isAdmin) { showToast('You must be an admin to change the background.', 'danger'); return; }
            const urlInput = document.getElementById('backgroundUrl');
            // Remove 'url(' and ')' for display
            urlInput.value = leagueData.backgroundUrl.replace(/^url\(['"]?/, '').replace(/['"]?\)$/, '');
            const modal = new bootstrap.Modal(document.getElementById('editBackgroundModal'));
            modal.show();
        }

        async function submitBackground() {
            if (!isAdmin) { showToast('Admin privileges required!', 'danger'); return; }

            const fileInput = document.getElementById('backgroundFile');
            const urlInput = document.getElementById('backgroundUrl');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBackgroundModal'));

            const urlValue = urlInput.value.trim();

            if (urlValue) {
                // Success: URL is provided and takes precedence
                leagueData.backgroundUrl = `url('${urlValue}')`;
                await saveData(false);
                applyBackground();
                modal.hide();
                showToast('Hero Background URL set successfully! 📸', 'success');
                return;
            }

            if (fileInput.files.length > 0) {
                 // Error: File is selected, but Firebase Storage is not initialized
                showToast('File upload is not enabled. Please upload the image to an image host (like Imgur) and use the **URL** option.', 'danger');
                return;
            }

            // Error: Neither file nor URL provided
            showToast('Please provide a URL to set the background.', 'danger');
        }

        async function resetBackground() {
            leagueData.backgroundUrl = 'url("stadium.jpg")';
            await saveData();
            applyBackground();
            document.getElementById('backgroundUrl').value = '';
            document.getElementById('backgroundFile').value = '';
            bootstrap.Modal.getInstance(document.getElementById('editBackgroundModal')).hide();
            showToast('Background reset to default!', 'warning');
        }
        
        // --- Player Management ---
        function showAddPlayerModal() {
            if (!isAdmin) { showToast('You must be an admin to add a player.', 'danger'); return; }
            document.getElementById('playerName').value = '';
            document.getElementById('playerAvatarUrl').value = '';
            document.getElementById('playerAvatarFile').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
            modal.show();
        }

        async function submitPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const url = document.getElementById('playerAvatarUrl').value.trim();
            const fileInput = document.getElementById('playerAvatarFile');

            if (!name) {
                showToast('Player name is required!', 'danger');
                return;
            }

            let avatarUrl = url || defaultAvatar;

            if (fileInput.files.length > 0) {
                showToast('File upload is not enabled. Please use the **URL** option for the avatar.', 'danger');
                return;
            }

            const newPlayer = {
                id: Date.now().toString(), // Simple unique ID
                name: name,
                avatar: avatarUrl,
                mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0, form: []
            };

            leagueData.players.push(newPlayer);
            await saveData();
            populateTeamSelector();
            populateFixtureSelectors();
            bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide();
            showToast('Player added successfully! ⚽', 'success');
        }

        // --- Fixture Management ---
        function populateFixtureSelectors() {
            const select1 = document.getElementById('fixturePlayer1');
            const select2 = document.getElementById('fixturePlayer2');
            
            // Clear existing options
            select1.innerHTML = '<option value="">Select Player 1</option>';
            select2.innerHTML = '<option value="">Select Player 2</option>';
            
            leagueData.players.forEach(player => {
                const option1 = new Option(player.name, player.id);
                const option2 = new Option(player.name, player.id);
                select1.add(option1);
                select2.add(option2);
            });
        }

        function showAddFixtureModal() {
            if (!isAdmin) { showToast('You must be an admin to add a fixture.', 'danger'); return; }
            populateFixtureSelectors();
            document.getElementById('fixtureMatchday').value = totalMatchdays > 0 ? totalMatchdays : 1;
            document.getElementById('fixtureDate').value = new Date().toISOString().slice(0, 10);
            const modal = new bootstrap.Modal(document.getElementById('addFixtureModal'));
            modal.show();
        }

        async function submitFixture() {
            const player1Id = document.getElementById('fixturePlayer1').value;
            const player2Id = document.getElementById('fixturePlayer2').value;
            const date = document.getElementById('fixtureDate').value;
            const matchday = parseInt(document.getElementById('fixtureMatchday').value);

            if (!player1Id || !player2Id || player1Id === player2Id || !date || isNaN(matchday) || matchday < 1) {
                showToast('Invalid fixture details. Select two different players, a date, and a valid matchday.', 'danger');
                return;
            }

            const newFixture = {
                id: Date.now().toString(), // Simple unique ID
                player1Id: player1Id,
                player2Id: player2Id,
                date: date,
                matchday: matchday,
                isPlayed: false
            };

            leagueData.fixtures.push(newFixture);
            await saveData();
            calculateTotalMatchdays();
            bootstrap.Modal.getInstance(document.getElementById('addFixtureModal')).hide();
            showToast('Fixture added successfully! 📅', 'success');
        }

        function generateFixtures() {
            if (!isAdmin) { showToast('You must be an admin to generate fixtures.', 'danger'); return; }
            if (leagueData.players.length < 2) {
                showToast('Need at least 2 players to generate fixtures!', 'danger');
                return;
            }

            if (leagueData.fixtures.some(f => !f.isPlayed)) {
                if (!confirm("Unplayed fixtures exist. Are you sure you want to clear them and generate a new full round robin?")) {
                    return;
                }
            }
            
            // Basic Round Robin Scheduling (Home/Away for 2 rounds)
            let players = leagueData.players.map(p => p.id);
            let n = players.length;
            if (n % 2 !== 0) {
                players.push('BYE'); // Add a virtual "BYE" player for odd numbers
                n++;
            }
            
            let numRounds = (leagueData.players.length - 1) * 2; // Double round robin
            leagueData.fixtures = [];

            for (let round = 1; round <= numRounds; round++) {
                let currentMatchday = round;
                
                for (let i = 0; i < n / 2; i++) {
                    let p1 = players[i];
                    let p2 = players[n - 1 - i];

                    if (p1 !== 'BYE' && p2 !== 'BYE') {
                        // Alternate Home/Away
                        let homeId = (round % 2 === 1) ? p1 : p2;
                        let awayId = (round % 2 === 1) ? p2 : p1;

                        const newFixture = {
                            id: `${Date.now()}-${round}-${i}`,
                            player1Id: homeId,
                            player2Id: awayId,
                            date: `TBD (Matchday ${currentMatchday})`,
                            matchday: currentMatchday,
                            isPlayed: false
                        };
                        leagueData.fixtures.push(newFixture);
                    }
                }
                
                // Rotate players (Keep player 0 fixed)
                let temp = players[n - 1];
                for (let i = n - 1; i > 1; i--) {
                    players[i] = players[i - 1];
                }
                players[1] = temp;
            }

            calculateTotalMatchdays();
            saveData();
            showToast('Full season fixtures generated successfully! 🗓️', 'success');
        }

        // --- Result Management ---
        function showResultModal(fixtureId) {
            if (!isAdmin) { showToast('You must be an admin to enter results.', 'danger'); return; }
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) return;

            const p1 = leagueData.players.find(p => p.id === fixture.player1Id);
            const p2 = leagueData.players.find(p => p.id === fixture.player2Id);

            if (!p1 || !p2) { showToast('Player data missing for this fixture.', 'danger'); return; }

            document.getElementById('resultFixtureId').value = fixtureId;
            document.getElementById('resultModalPlayer1Name').textContent = p1.name;
            document.getElementById('resultModalPlayer2Name').textContent = p2.name;
            document.getElementById('resultScore1').value = '';
            document.getElementById('resultScore2').value = '';

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }

        async function submitResult() {
            const fixtureId = document.getElementById('resultFixtureId').value;
            const score1 = parseInt(document.getElementById('resultScore1').value);
            const score2 = parseInt(document.getElementById('resultScore2').value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showToast('Scores must be valid non-negative numbers.', 'danger');
                return;
            }

            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (!fixture) return;

            // Mark fixture as played
            fixture.isPlayed = true;

            const newResult = {
                fixtureId: fixtureId,
                player1Id: fixture.player1Id,
                player2Id: fixture.player2Id,
                score1: score1,
                score2: score2,
                matchday: fixture.matchday,
                timestamp: Date.now()
            };

            // Remove any existing result for this fixture before adding the new one
            leagueData.results = leagueData.results.filter(r => r.fixtureId !== fixtureId);
            leagueData.results.push(newResult);
            
            // Re-calculate all player stats
            recalculateStandings();
            
            await saveData();
            updateLiveTicker();
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
            showToast('Result submitted successfully! ⚽🥅', 'success');
        }

        function recalculateStandings() {
            // 1. Reset all player stats
            leagueData.players.forEach(player => {
                player.mp = 0; player.w = 0; player.d = 0; player.l = 0; player.gf = 0; player.ga = 0; player.gd = 0; player.pts = 0; player.form = [];
            });

            // 2. Process all results
            const sortedResults = leagueData.results.sort((a, b) => b.timestamp - a.timestamp); // Process in reverse chronological order for form

            sortedResults.forEach(result => {
                const p1 = leagueData.players.find(p => p.id === result.player1Id);
                const p2 = leagueData.players.find(p => p.id === result.player2Id);

                if (!p1 || !p2) return;

                // Update Player 1 Stats
                p1.mp++;
                p1.gf += result.score1;
                p1.ga += result.score2;

                if (result.score1 > result.score2) { // Win
                    p1.w++;
                    p1.pts += 3;
                    if (p1.form.length < 5) p1.form.unshift('W');
                } else if (result.score1 < result.score2) { // Loss
                    p1.l++;
                    if (p1.form.length < 5) p1.form.unshift('L');
                } else { // Draw
                    p1.d++;
                    p1.pts += 1;
                    if (p1.form.length < 5) p1.form.unshift('D');
                }

                // Update Player 2 Stats
                p2.mp++;
                p2.gf += result.score2;
                p2.ga += result.score1;

                if (result.score2 > result.score1) { // Win
                    p2.w++;
                    p2.pts += 3;
                    if (p2.form.length < 5) p2.form.unshift('W');
                } else if (result.score2 < result.score1) { // Loss
                    p2.l++;
                    if (p2.form.length < 5) p2.form.unshift('L');
                } else { // Draw
                    p2.d++;
                    p2.pts += 1;
                    if (p2.form.length < 5) p2.form.unshift('D');
                }
            });

            // 3. Final calculations (GD) and sorting (Done in updateStandings)
            leagueData.players.forEach(player => {
                player.gd = player.gf - player.ga;
            });
        }
        
        // --- View Updates ---
        
        // Update Standings Table
        function updateStandings() {
            recalculateStandings(); // Ensure stats are up to date
            const tableBody = document.getElementById('standingsTable');
            tableBody.innerHTML = '';

            // Sorting: Points > GD > GF > Name
            const sortedPlayers = [...leagueData.players].sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;
                if (b.gf !== a.gf) return b.gf - a.gf;
                return a.name.localeCompare(b.name);
            });

            sortedPlayers.forEach((player, index) => {
                let rowClass = '';
                if (index < 3) rowClass = 'top-team-row'; // Top 3
                else if (index >= sortedPlayers.length - 3) rowClass = 'bottom-team-row'; // Bottom 3

                const formHtml = player.form.map(f => `<span class="form-bubble form-bubble-${f}">${f}</span>`).join('');

                const row = `
                    <tr class="${rowClass}">
                        <td class="pos-cell">${index + 1}</td>
                        <td class="player-name-cell">
                            <img src="${player.avatar}" alt="${player.name} avatar">
                            <a href="#player-${player.id}" class="player-profile-link">${player.name}</a>
                            ${isAdmin ? `<i class="fa-solid fa-trash text-danger ms-2 admin-mode" style="cursor:pointer;" onclick="deletePlayer('${player.id}')"></i>` : ''}
                        </td>
                        <td>${player.mp}</td>
                        <td>${player.w}</td>
                        <td>${player.d}</td>
                        <td>${player.l}</td>
                        <td>${player.gf}</td>
                        <td>${player.ga}</td>
                        <td>${player.gd}</td>
                        <td class="form-cell">${formHtml}</td>
                        <td class="pts-cell">${player.pts}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            // Re-apply admin visibility
            if(isAdmin) {
                 document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'block');
            }
        }
        
        // Update Fixtures
        function updateFixtures() {
            const container = document.getElementById('fixturesContainer');
            container.innerHTML = '';
            document.getElementById('currentMatchday').textContent = `Matchday ${currentMatchday}`;
            
            const fixtures = leagueData.fixtures
                .filter(f => f.matchday === currentMatchday)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            fixtures.forEach(fixture => {
                const p1 = leagueData.players.find(p => p.id === fixture.player1Id);
                const p2 = leagueData.players.find(p => p.id === fixture.player2Id);

                if (!p1 || !p2) return;

                // Skip fixtures that have results for the fixtures tab
                const isPlayed = leagueData.results.some(r => r.fixtureId === fixture.id);
                if (isPlayed) return;

                const dateDisplay = fixture.date.includes('TBD') ? fixture.date : new Date(fixture.date).toLocaleDateString();

                const card = `
                    <div class="match-card">
                        <div class="match-player">
                            <img src="${p1.avatar}" alt="${p1.name}">
                            <span>${p1.name}</span>
                        </div>
                        <div class="match-info">
                            <span class="date">${dateDisplay}</span>
                            <span class="vs">VS</span>
                        </div>
                        <div class="match-player">
                            <span>${p2.name}</span>
                            <img src="${p2.avatar}" alt="${p2.name}">
                        </div>
                        <div class="admin-controls admin-mode">
                             <button class="btn btn-sm btn-primary" onclick="showResultModal('${fixture.id}')">
                                <i class="fa-solid fa-clipboard-list"></i> Result
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFixture('${fixture.id}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
            
            if (container.innerHTML === '') {
                container.innerHTML = '<div class="text-center text-secondary py-4">No unplayed fixtures found for this matchday.</div>';
            }

            // Re-apply admin visibility
            if(isAdmin) {
                 document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'block');
            }
        }

        function changeMatchday(direction) {
            let newMatchday = currentMatchday + direction;
            if (newMatchday >= 1 && newMatchday <= totalMatchdays) {
                currentMatchday = newMatchday;
                updateFixtures();
            } else {
                 showToast('No more matchdays in that direction. ⚠️', 'info');
            }
        }

        // Update Results
        function updateResults(filterPlayerId = '') {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            const sortedResults = leagueData.results.sort((a, b) => b.timestamp - a.timestamp); // Newest first

            sortedResults.forEach(result => {
                if (filterPlayerId && result.player1Id !== filterPlayerId && result.player2Id !== filterPlayerId) {
                    return; // Skip if not the filtered player
                }
                
                const fixture = leagueData.fixtures.find(f => f.id === result.fixtureId);
                const p1 = leagueData.players.find(p => p.id === result.player1Id);
                const p2 = leagueData.players.find(p => p.id === result.player2Id);

                if (!p1 || !p2) return;

                const dateDisplay = fixture ? (fixture.date.includes('TBD') ? '' : new Date(fixture.date).toLocaleDateString()) : '';
                const winner1Class = result.score1 > result.score2 ? 'winner' : '';
                const winner2Class = result.score2 > result.score1 ? 'winner' : '';

                const card = `
                    <div class="result-card">
                        <div class="result-player">
                            <img src="${p1.avatar}" alt="${p1.name}">
                            <span>${p1.name}</span>
                        </div>
                        <div class="result-info">
                            <div class="score"><span class="${winner1Class}">${result.score1}</span> - <span class="${winner2Class}">${result.score2}</span></div>
                            <span class="date">${dateDisplay}</span>
                        </div>
                        <div class="result-player">
                            <span>${p2.name}</span>
                            <img src="${p2.avatar}" alt="${p2.name}">
                        </div>
                        <div class="admin-controls admin-mode">
                             <button class="btn btn-sm btn-danger" onclick="deleteResult('${result.fixtureId}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });

            if (container.innerHTML === '') {
                container.innerHTML = '<div class="text-center text-secondary py-4">No results found.</div>';
            }
            // Re-apply admin visibility
            if(isAdmin) {
                 document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'block');
            }
        }

        function populateTeamSelector() {
            const selector = document.getElementById('teamSelector');
            const selectedValue = selector.value; // Preserve current selection
            selector.innerHTML = '<option value="">Show All</option>';
            leagueData.players.forEach(player => {
                const option = new Option(player.name, player.id);
                selector.add(option);
            });
            selector.value = selectedValue; // Restore selection
        }

        function filterTeamResults() {
            const filterId = document.getElementById('teamSelector').value;
            updateResults(filterId);
        }

        // Update Players Section
        function updatePlayers() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';

            leagueData.players.forEach(player => {
                const card = `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-4" id="player-${player.id}">
                        <div class="player-card">
                            <img src="${player.avatar}" alt="${player.name}">
                            <h5 class="card-title">${player.name}</h5>
                            <p class="card-text">${player.pts} PTS</p>
                             <div class="admin-mode">
                                <button class="btn btn-sm btn-danger" onclick="deletePlayer('${player.id}')">
                                    <i class="fa-solid fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
            // Re-apply admin visibility
            if(isAdmin) {
                 document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'block');
            }
        }
        
        // --- Delete Functions ---
        async function deletePlayer(playerId) {
            if (!isAdmin) { showToast('You must be an admin.', 'danger'); return; }
            if (confirm("Are you sure you want to delete this player? All their fixtures and results will also be deleted.")) {
                leagueData.players = leagueData.players.filter(p => p.id !== playerId);
                leagueData.fixtures = leagueData.fixtures.filter(f => f.player1Id !== playerId && f.player2Id !== playerId);
                leagueData.results = leagueData.results.filter(r => r.player1Id !== playerId && r.player2Id !== playerId);
                recalculateStandings();
                await saveData();
                populateTeamSelector();
                populateFixtureSelectors();
                calculateTotalMatchdays();
                showToast('Player and related data deleted! 🗑️', 'success');
            }
        }

        async function deleteFixture(fixtureId) {
             if (!isAdmin) { showToast('You must be an admin.', 'danger'); return; }
             leagueData.fixtures = leagueData.fixtures.filter(f => f.id !== fixtureId);
             leagueData.results = leagueData.results.filter(r => r.fixtureId !== fixtureId);
             recalculateStandings();
             await saveData();
             calculateTotalMatchdays();
             showToast('Fixture and result (if any) deleted! 🗑️', 'success');
        }

        async function deleteResult(fixtureId) {
            if (!isAdmin) { showToast('You must be an admin.', 'danger'); return; }
            // Find the fixture and mark it as unplayed
            const fixture = leagueData.fixtures.find(f => f.id === fixtureId);
            if (fixture) {
                fixture.isPlayed = false;
            }
            // Remove the result
            leagueData.results = leagueData.results.filter(r => r.fixtureId !== fixtureId);
            recalculateStandings();
            await saveData();
            showToast('Result deleted! Fixture is now unplayed. ↩️', 'warning');
        }

        async function resetLeague() {
            if (!isAdmin) { showToast('You must be an admin.', 'danger'); return; }
            if (confirm("WARNING: This will delete ALL fixtures, results, and player statistics. Are you sure you want to proceed?")) {
                leagueData.fixtures = [];
                leagueData.results = [];
                leagueData.players.forEach(p => { // Keep players but reset their stats
                    p.mp = 0; p.w = 0; p.d = 0; p.l = 0; p.gf = 0; p.ga = 0; p.gd = 0; p.pts = 0; p.form = [];
                });
                currentMatchday = 1;
                totalMatchdays = 1;
                await saveData();
                showToast('League reset successfully! 🔄', 'success');
            }
        }
        
        // --- Import/Export ---
        function importData() {
            if (!isAdmin) { showToast('You must be an admin to import data.', 'danger'); return; }
            const json = document.getElementById('dataJson').value;
            if (!json) { showToast('Paste JSON data first!', 'danger'); return; }
            try {
                const data = JSON.parse(json);
                if (!data.players || !data.fixtures || !data.results) {
                    showToast('Invalid JSON structure! Missing players, fixtures, or results keys.', 'danger'); return;
                }
                leagueData = data;
                if(!leagueData.backgroundUrl) leagueData.backgroundUrl = 'url("stadium.jpg")'; // Ensure background field exists
                if(!leagueData.introImageUrl) leagueData.introImageUrl = 'https://i.imgur.com/8Qj9Y0b.png'; // Ensure intro image field exists
                
                recalculateStandings(); // Ensure imported stats are recalculated
                applyBackground();
                
                saveData();
                populateTeamSelector();
                populateFixtureSelectors();
                calculateTotalMatchdays();
                showToast('Data imported successfully! 📥', 'success');
            } catch (e) {
                showToast('Invalid JSON! ' + e.message, 'danger');
            }
        }

        function exportData() {
            const json = JSON.stringify(leagueData, null, 2);
            document.getElementById('dataJson').value = json;
            document.getElementById('dataJson').select();
            try {
                navigator.clipboard.writeText(json).then(() => {
                    showToast('Data exported and copied to clipboard! 📋', 'success');
                }).catch(() => {
                    showToast('Data exported. Copy it from the text box.', 'info');
                });
            } catch (err) {
                showToast('Data exported. Copy it from the text box.', 'info');
            }
        }


        // --- DOMContentLoaded Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach listeners
            themeToggle.addEventListener('click', toggleTheme);
            document.getElementById('admin-login-button').addEventListener('click', showAdminLogin);
            
            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            
            // Load data (this function now triggers the intro sequence)
            loadData(); 

            // Hide all admin controls initially
            document.querySelectorAll('.admin-mode').forEach(el => el.style.display = 'none');
        });
    </script>
</body>
</html>
